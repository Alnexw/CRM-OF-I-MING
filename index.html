<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜“æ˜ CRMï½œé›²ç«¯ç‰ˆ</title>
<style>
  :root {
    --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#eff6ff;
    --success:#16a34a;--warning:#d97706;--danger:#dc2626;
    --gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
    --gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;
    --gray-800:#1f2937;--gray-900:#111827;--sidebar-width:220px;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Microsoft JhengHei','Segoe UI',sans-serif;background:var(--gray-50);color:var(--gray-800);display:flex;height:100vh;overflow:hidden;font-size:14px;}
  #sidebar{width:var(--sidebar-width);background:#1e293b;color:#e2e8f0;display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;}
  .sidebar-logo{padding:20px 16px;border-bottom:1px solid #334155;font-size:15px;font-weight:700;color:#fff;display:flex;align-items:center;gap:10px;}
  .sidebar-logo .logo-icon{width:32px;height:32px;background:var(--primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
  .sidebar-section{padding:8px 0;}
  .sidebar-section-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:#64748b;padding:8px 16px 4px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;cursor:pointer;transition:background .15s;color:#94a3b8;font-size:13.5px;border-left:3px solid transparent;}
  .nav-item:hover{background:#273549;color:#e2e8f0;}
  .nav-item.active{background:#1e3a5f;color:#fff;border-left-color:var(--primary);}
  .nav-item .nav-icon{font-size:16px;width:20px;text-align:center;}
  .nav-badge{margin-left:auto;background:var(--danger);color:#fff;border-radius:10px;font-size:11px;padding:1px 6px;font-weight:600;}
  .sidebar-user{padding:14px 16px;border-top:1px solid #334155;display:flex;align-items:center;gap:10px;margin-top:auto;}
  .user-avatar{width:30px;height:30px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0;}
  .user-name{font-size:13px;color:#cbd5e1;font-weight:500;}
  #main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  #topbar{background:#fff;border-bottom:1px solid var(--gray-200);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
  #topbar h1{font-size:17px;font-weight:700;color:var(--gray-900);}
  .topbar-right{display:flex;align-items:center;gap:12px;}
  #sync-status{font-size:12px;color:var(--gray-400);cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .15s;}
  #sync-status:hover{background:var(--gray-100);}
  #content{flex:1;overflow-y:auto;padding:24px;}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:13.5px;font-weight:500;cursor:pointer;border:1px solid transparent;transition:all .15s;}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary);}
  .btn-primary:hover{background:var(--primary-dark);}
  .btn-secondary{background:#fff;color:var(--gray-700);border-color:var(--gray-300);}
  .btn-secondary:hover{background:var(--gray-50);}
  .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger);}
  .btn-sm{padding:4px 10px;font-size:12.5px;}
  .btn-xs{padding:2px 8px;font-size:11.5px;}
  .card{background:#fff;border:1px solid var(--gray-200);border-radius:10px;}
  .card-header{padding:16px 20px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;}
  .card-title{font-size:14px;font-weight:600;color:var(--gray-800);}
  .card-body{padding:20px;}
  .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px;}
  .stat-card{background:#fff;border:1px solid var(--gray-200);border-radius:10px;padding:20px;}
  .stat-label{font-size:12px;color:var(--gray-500);font-weight:500;margin-bottom:8px;}
  .stat-value{font-size:28px;font-weight:700;color:var(--gray-900);}
  .stat-sub{font-size:12px;color:var(--gray-500);margin-top:4px;}
  .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:12px;}
  .dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .dash-full{grid-column:1/-1;}
  .table-wrap{overflow-x:auto;}
  table{width:100%;border-collapse:collapse;}
  th{background:var(--gray-50);color:var(--gray-600);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;padding:10px 14px;text-align:left;border-bottom:1px solid var(--gray-200);}
  td{padding:12px 14px;border-bottom:1px solid var(--gray-100);color:var(--gray-800);vertical-align:middle;}
  tr:hover td{background:var(--gray-50);}
  tr:last-child td{border-bottom:none;}
  .toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
  .search-box{position:relative;}
  .search-box input{padding:7px 12px 7px 34px;border:1px solid var(--gray-300);border-radius:7px;font-size:13.5px;outline:none;width:220px;color:var(--gray-700);}
  .search-box input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
  .search-box .search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:14px;}
  select.filter-select{padding:7px 10px;border:1px solid var(--gray-300);border-radius:7px;font-size:13.5px;outline:none;color:var(--gray-700);cursor:pointer;background:#fff;}
  select.filter-select:focus{border-color:var(--primary);}
  .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:11.5px;font-weight:600;}
  .badge-blue{background:#dbeafe;color:#1d4ed8;}.badge-green{background:#dcfce7;color:#15803d;}
  .badge-yellow{background:#fef9c3;color:#854d0e;}.badge-red{background:#fee2e2;color:#b91c1c;}
  .badge-purple{background:#f3e8ff;color:#7e22ce;}.badge-gray{background:var(--gray-100);color:var(--gray-600);}
  .pri-high{color:var(--danger);font-weight:600;}.pri-med{color:var(--warning);font-weight:600;}.pri-low{color:var(--success);font-weight:600;}
  .pipeline-board{display:flex;gap:14px;overflow-x:auto;padding-bottom:16px;min-height:500px;}
  .pipeline-col{flex:0 0 220px;display:flex;flex-direction:column;}
  .pipeline-col-header{border-radius:8px 8px 0 0;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;}
  .pipeline-col-title{font-size:12.5px;font-weight:700;}
  .pipeline-col-count{background:rgba(0,0,0,.15);border-radius:10px;font-size:11px;font-weight:700;padding:1px 7px;color:#fff;}
  .pipeline-col-body{flex:1;background:var(--gray-100);border-radius:0 0 8px 8px;padding:8px;display:flex;flex-direction:column;gap:8px;min-height:200px;}
  .pipeline-card{background:#fff;border:1px solid var(--gray-200);border-radius:8px;padding:12px;cursor:pointer;transition:box-shadow .15s;}
  .pipeline-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.1);}
  .pipeline-card.dragging{opacity:.35;transform:rotate(2deg) scale(.97);box-shadow:0 8px 24px rgba(0,0,0,.18);}
  .pipeline-col-body.drag-over{background:#dbeafe;border:2px dashed #2563eb;border-radius:0 0 8px 8px;}
  .pipeline-col-body.drag-over-invalid{background:#fee2e2;border:2px dashed #ef4444;}
  .pipeline-card[draggable]{cursor:grab;}
  .pipeline-card[draggable]:active{cursor:grabbing;}
  .pipeline-card-title{font-size:13px;font-weight:600;color:var(--gray-800);margin-bottom:6px;}
  .pipeline-card-company{font-size:12px;color:var(--gray-500);margin-bottom:8px;}
  .pipeline-card-value{font-size:13px;font-weight:700;color:var(--primary);}
  .pipeline-card-date{font-size:11px;color:var(--gray-400);margin-top:6px;}
  .stage-0{background:#6366f1;}.stage-1{background:#0ea5e9;}.stage-2{background:#f59e0b;}
  .stage-3{background:#f97316;}.stage-4{background:#22c55e;}.stage-5{background:#ef4444;}
  .timeline{display:flex;flex-direction:column;}
  .timeline-item{display:flex;gap:16px;padding:14px 0;border-bottom:1px solid var(--gray-100);}
  .timeline-item:last-child{border-bottom:none;}
  .timeline-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px;}
  .timeline-content{flex:1;}
  .timeline-header{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap;}
  .timeline-subject{font-size:13.5px;font-weight:600;color:var(--gray-800);}
  .timeline-date{font-size:12px;color:var(--gray-400);margin-left:auto;white-space:nowrap;}
  .timeline-notes{font-size:13px;color:var(--gray-600);line-height:1.5;}
  .task-item{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--gray-100);}
  .task-item:last-child{border-bottom:none;}
  .task-check{width:18px;height:18px;border:2px solid var(--gray-300);border-radius:4px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;margin-top:1px;transition:all .15s;}
  .task-check.done{background:var(--success);border-color:var(--success);color:#fff;}
  .task-content{flex:1;}
  .task-title{font-size:13.5px;font-weight:500;color:var(--gray-800);}
  .task-title.done-text{text-decoration:line-through;color:var(--gray-400);}
  .task-meta{font-size:12px;color:var(--gray-500);margin-top:3px;display:flex;gap:10px;flex-wrap:wrap;}
  .task-overdue{color:var(--danger);font-weight:600;}
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  .modal{background:#fff;border-radius:12px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);}
  .modal-lg{max-width:700px;}.modal-xl{max-width:860px;}
  .modal-header{padding:18px 22px;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;justify-content:space-between;}
  .modal-title{font-size:16px;font-weight:700;}
  .modal-close{cursor:pointer;font-size:20px;color:var(--gray-400);background:none;border:none;line-height:1;padding:0;}
  .modal-close:hover{color:var(--gray-700);}
  .modal-body{padding:22px;}
  .modal-footer{padding:16px 22px;border-top:1px solid var(--gray-100);display:flex;justify-content:flex-end;gap:10px;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .form-full{grid-column:1/-1;}
  .form-group{display:flex;flex-direction:column;gap:5px;}
  .form-label{font-size:12.5px;font-weight:600;color:var(--gray-700);}
  .form-input,.form-select,.form-textarea{padding:8px 12px;border:1px solid var(--gray-300);border-radius:7px;font-size:13.5px;outline:none;color:var(--gray-800);font-family:inherit;width:100%;}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
  .form-textarea{resize:vertical;min-height:80px;}
  .form-hint{font-size:11.5px;color:var(--gray-400);margin-top:2px;}
  #toast{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px;}
  .toast-item{background:#1e293b;color:#e2e8f0;padding:12px 18px;border-radius:8px;font-size:13.5px;box-shadow:0 4px 16px rgba(0,0,0,.2);animation:slideIn .2s ease;display:flex;align-items:center;gap:8px;}
  .toast-item.success{background:#166534;}.toast-item.error{background:#991b1b;}
  @keyframes slideIn{from{transform:translateX(40px);opacity:0}to{transform:none;opacity:1}}
  .empty-state{text-align:center;padding:60px 20px;color:var(--gray-400);}
  .empty-state .empty-icon{font-size:48px;margin-bottom:16px;}
  .empty-state .empty-title{font-size:16px;font-weight:600;color:var(--gray-500);margin-bottom:8px;}
  .text-link{color:var(--primary);cursor:pointer;font-weight:500;}
  .text-link:hover{text-decoration:underline;}
  .ml-auto{margin-left:auto;}
  .actions-cell{display:flex;gap:6px;}
  /* Setup wizard */
  .setup-step{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:16px;margin-bottom:14px;}
  .setup-step-num{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:var(--primary);color:#fff;border-radius:50%;font-size:12px;font-weight:700;margin-right:8px;flex-shrink:0;}
  .setup-step-title{font-size:14px;font-weight:700;color:var(--gray-800);display:flex;align-items:center;}
  .setup-step-body{margin-top:10px;padding-left:32px;}
  .code-block{background:#0f172a;color:#e2e8f0;padding:14px;border-radius:8px;font-size:12px;font-family:monospace;overflow-x:auto;white-space:pre;line-height:1.6;position:relative;max-height:200px;overflow-y:auto;}
  .copy-btn{position:absolute;top:8px;right:8px;background:#334155;color:#e2e8f0;border:none;border-radius:5px;padding:4px 10px;font-size:11px;cursor:pointer;}
  .copy-btn:hover{background:#475569;}
  .alert-info{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 14px;font-size:13px;color:#1d4ed8;}
  .alert-warning{background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px 14px;font-size:13px;color:#92400e;}
  .user-list-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--gray-100);}
  .user-list-item:last-child{border-bottom:none;}
  ::-webkit-scrollbar{width:6px;height:6px;}
  ::-webkit-scrollbar-thumb{background:var(--gray-300);border-radius:3px;}
  /* Mass Email */
  .merge-chip{display:inline-flex;align-items:center;background:#dbeafe;color:#1d4ed8;border:1px solid #bfdbfe;border-radius:6px;padding:3px 10px;font-size:12px;cursor:pointer;font-family:monospace;font-weight:600;}
  .merge-chip:hover{background:#bfdbfe;}
  .recipient-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--gray-100);}
  .recipient-row:last-child{border-bottom:none;}
  .preview-email{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:20px;margin-bottom:12px;}
  .preview-email-header{border-bottom:1px solid var(--gray-200);padding-bottom:10px;margin-bottom:10px;}
  @keyframes pulse{from{opacity:.7}to{opacity:1}}
  #global-search-wrap{position:relative;}
  #global-search-input{padding:6px 12px 6px 32px;border:1px solid var(--gray-300);border-radius:20px;font-size:13px;outline:none;width:200px;color:var(--gray-700);transition:width .2s;}
  #global-search-input:focus{width:280px;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
  #global-search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:13px;pointer-events:none;}
  #search-results{position:absolute;top:calc(100% + 6px);right:0;width:360px;background:#fff;border:1px solid var(--gray-200);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:500;max-height:420px;overflow-y:auto;display:none;}
  #search-results.open{display:block;}
  .sr-section{padding:8px 14px 4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--gray-400);}
  .sr-item{display:flex;align-items:center;gap:10px;padding:9px 14px;cursor:pointer;transition:background .1s;}
  .sr-item:hover{background:var(--gray-50);}
  .sr-icon{font-size:15px;width:22px;text-align:center;}
  .sr-main{font-size:13px;font-weight:600;color:var(--gray-800);}
  .sr-sub{font-size:11.5px;color:var(--gray-400);}
  .sr-empty{padding:20px;text-align:center;color:var(--gray-400);font-size:13px;}
  .project-card{background:#fff;border:1px solid var(--gray-200);border-radius:10px;padding:18px;cursor:pointer;transition:box-shadow .15s;}
  .project-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);}
  .project-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;}
  .progress-bar-wrap{background:var(--gray-100);border-radius:999px;height:8px;margin:6px 0;}
  .progress-bar-fill{height:8px;border-radius:999px;transition:width .3s;}
  .milestone-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--gray-100);}
  .milestone-item:last-child{border-bottom:none;}
  .ms-check{width:20px;height:20px;border:2px solid var(--gray-300);border-radius:50%;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;}
  .ms-check.done{background:var(--success);border-color:var(--success);color:#fff;}
  .budget-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--gray-100);font-size:13px;}
  .budget-row:last-child{border-bottom:none;}

</style>
</head>
<body>

<nav id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">ğŸ“Š</div>
    <span>æ˜“æ˜ CRM</span>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">ä¸»è¦åŠŸèƒ½</div>
    <div class="nav-item active" onclick="navigate('dashboard')"><span class="nav-icon">ğŸ </span><span>å„€è¡¨æ¿</span></div>
    <div class="nav-item" onclick="navigate('companies')"><span class="nav-icon">ğŸ¢</span><span>å…¬å¸å®¢æˆ¶</span></div>
    <div class="nav-item" onclick="navigate('contacts')"><span class="nav-icon">ğŸ‘¤</span><span>è¯çµ¡äºº</span></div>
    <div class="nav-item" onclick="navigate('pipeline')"><span class="nav-icon">ğŸ“ˆ</span><span>æ¥­å‹™ç®¡é“</span></div>
    <div class="nav-item" onclick="navigate('interactions')"><span class="nav-icon">ğŸ’¬</span><span>äº’å‹•è¨˜éŒ„</span></div>
        <div class="nav-item" onclick="navigate('massemail')"><span class="nav-icon">ğŸ“§</span><span>ç¾¤ç™¼éƒµä»¶</span></div>
<div class="nav-item" onclick="navigate('tasks')">
      <span class="nav-icon">âœ…</span><span>ä»»å‹™æé†’</span>
      <span class="nav-badge" id="task-badge" style="display:none">0</span>
    </div>
<div class="nav-item" onclick="navigate('salesstats')"><span class="nav-icon">ğŸ“Š</span><span>æ¥­ç¸¾çµ±è¨ˆ</span></div>
<div class="nav-item" onclick="navigate('projects')"><span class="nav-icon">ğŸš§</span><span>å°ˆæ¡ˆç®¡ç†</span><span class="nav-badge" id="project-badge" style="display:none">0</span></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">ç³»çµ±</div>
    <div class="nav-item" onclick="openModal('settingsModal')"><span class="nav-icon">âš™ï¸</span><span>é›²ç«¯è¨­å®š</span></div>
    <div class="nav-item" onclick="openModal('usersModal')"><span class="nav-icon">ğŸ‘¥</span><span>ä½¿ç”¨äººå“¡</span></div>
  </div>
  <div class="sidebar-user" id="sidebar-user" onclick="openModal('selfModal')" style="cursor:pointer" title="é»æ“Šè¨­å®šå§“å">
    <div class="user-avatar" id="user-avatar">æˆ‘</div>
    <div>
      <div class="user-name" id="user-name-display">è¨­å®šå§“å</div>
      <div style="font-size:11px;color:#64748b">é»æ“Šæ›´æ”¹</div>
    </div>
  </div>
</nav>

<div id="main">
  <div id="topbar">
    <h1 id="page-title">å„€è¡¨æ¿</h1>
    <div class="topbar-right">
      <div id="global-search-wrap">
        <span id="global-search-icon">ğŸ”</span>
        <input id="global-search-input" type="text" placeholder="æœå°‹å…¬å¸ã€è¯çµ¡äººã€å•†æ©Ÿ..." oninput="doGlobalSearch(this.value)" onfocus="doGlobalSearch(this.value)" onblur="setTimeout(()=>closeSearchResults(),200)">
        <div id="search-results"></div>
      </div>
      <span id="sync-status" onclick="manualSync()" title="é»æ“Šæ‰‹å‹•åŒæ­¥">ğŸ’¾ æœ¬æ©Ÿæ¨¡å¼</span>
      <button class="btn btn-primary btn-sm" id="add-btn" onclick="handleAddBtn()">ï¼‹ æ–°å¢</button>
    </div>
  </div>
  <div id="content"></div>
</div>

<div id="toast"></div>

<!-- ===== MODALS ===== -->

<!-- è¨­å®šæˆ‘çš„åå­— -->
<div class="modal-overlay" id="selfModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-header"><span class="modal-title">è¨­å®šæ‚¨çš„å§“å</span><button class="modal-close" onclick="closeModal('selfModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">æ‚¨çš„å§“åï¼ˆæœƒé¡¯ç¤ºåœ¨äº’å‹•è¨˜éŒ„ä¸­ï¼‰</label>
        <input class="form-input" id="self-name" placeholder="ä¾‹ï¼šç‹å¿—æ˜">
      </div>
      <div style="margin-top:12px" class="alert-info">ğŸ’¡ æ­¤è¨­å®šåªå­˜åœ¨æ‚¨çš„è£ç½®ï¼Œæ¯ä½ä½¿ç”¨è€…å„è‡ªè¨­å®šè‡ªå·±çš„å§“åå³å¯ã€‚</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('selfModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveSelfName()">ç¢ºèª</button>
    </div>
  </div>
</div>

<!-- ä½¿ç”¨äººå“¡èªªæ˜ -->
<div class="modal-overlay" id="usersModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title">ğŸ‘¥ ä½¿ç”¨äººå“¡ç®¡ç†</span><button class="modal-close" onclick="closeModal('usersModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="alert-info" style="margin-bottom:16px">
        â„¹ï¸ é€™å¥— CRM æ¡ç”¨ã€Œé–‹æ”¾ä¿¡ä»»ã€æ¨¡å¼ï¼Œä¸éœ€è¦å¸³è™Ÿå¯†ç¢¼ç™»å…¥ã€‚<br>æ¯ä½ä½¿ç”¨è€…åªéœ€è¨­å®šè‡ªå·±çš„å§“åï¼Œä¸¦å–å¾—æ­¤ HTML æª”æ¡ˆå³å¯é–‹å§‹ä½¿ç”¨ã€‚
      </div>
      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">1</span>è®“æ–°åŒäº‹åŠ å…¥çš„æ–¹æ³•</div>
        <div class="setup-step-body" style="font-size:13.5px;color:var(--gray-600);line-height:1.8">
          â‘  å°‡æ­¤ <code style="background:var(--gray-100);padding:1px 5px;border-radius:4px">CRMç³»çµ±_é›²ç«¯ç‰ˆ.html</code> æª”æ¡ˆåˆ†äº«çµ¦åŒäº‹ï¼ˆä¾‹å¦‚ï¼šæ”¾åœ¨å…¬å¸çš„ Google Driveã€NASã€æˆ–ç”¨ Line å‚³é€ï¼‰<br>
          â‘¡ åŒäº‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿæ­¤æª”æ¡ˆ<br>
          â‘¢ é»æ“Šå·¦ä¸‹è§’ã€Œè¨­å®šå§“åã€ï¼Œè¼¸å…¥è‡ªå·±çš„åå­—<br>
          â‘£ é€²å…¥ã€Œâš™ï¸ é›²ç«¯è¨­å®šã€ï¼Œè²¼ä¸Šç›¸åŒçš„ Google Apps Script ç¶²å€<br>
          â‘¤ å®Œæˆï¼æ‰€æœ‰äººçš„è³‡æ–™éƒ½æœƒåŒæ­¥åˆ°åŒä¸€å€‹ Google è©¦ç®—è¡¨
        </div>
      </div>
      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">2</span>è³‡æ–™å­˜å–æ§åˆ¶</div>
        <div class="setup-step-body" style="font-size:13.5px;color:var(--gray-600);line-height:1.8">
          è³‡æ–™å®‰å…¨æ€§ç”± Google è©¦ç®—è¡¨çš„åˆ†äº«æ¬Šé™æ§ç®¡ã€‚<br>
          åªè¦æ§ç®¡å¥½ Google è©¦ç®—è¡¨çš„å­˜å–æ¬Šé™ï¼Œå°±èƒ½æ±ºå®šèª°å¯ä»¥çœ‹åˆ° CRM è³‡æ–™ã€‚<br>
          å»ºè­°ï¼šå°‡è©¦ç®—è¡¨è¨­ç‚ºã€Œé™åˆ¶ç‰¹å®šäººå“¡ã€ï¼Œä¸¦åªåˆ†äº«çµ¦å…¬å¸å…§éƒ¨å“¡å·¥ã€‚
        </div>
      </div>
      <div id="active-users-list" style="margin-top:12px">
        <div class="section-title" style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">æœ€è¿‘çš„ä½¿ç”¨ç´€éŒ„ï¼ˆä¾äº’å‹•è¨˜éŒ„ï¼‰</div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" onclick="closeModal('usersModal')">äº†è§£</button></div>
  </div>
</div>

<!-- Google Sheets è¨­å®š -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal modal-xl">
    <div class="modal-header">
      <span class="modal-title">âš™ï¸ Google Sheets é›²ç«¯è¨­å®š</span>
      <button class="modal-close" onclick="closeModal('settingsModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="settings-status-bar" style="margin-bottom:16px"></div>

      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">1</span>å»ºç«‹ Google è©¦ç®—è¡¨</div>
        <div class="setup-step-body">
          <a href="https://sheets.new" target="_blank" class="btn btn-secondary btn-sm" style="margin-bottom:8px">ğŸ”— é»æ­¤å»ºç«‹æ–°è©¦ç®—è¡¨</a>
          <p style="font-size:13px;color:var(--gray-600)">å»ºç«‹å¾Œï¼Œå°‡è©¦ç®—è¡¨å‘½åç‚ºã€Œæ˜“æ˜ CRM è³‡æ–™åº«ã€ï¼ˆå¯éš¨æ„å‘½åï¼‰ã€‚</p>
        </div>
      </div>

      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">2</span>é–‹å•Ÿ Apps Script ä¸¦è²¼ä¸Šç¨‹å¼ç¢¼</div>
        <div class="setup-step-body">
          <p style="font-size:13px;color:var(--gray-600);margin-bottom:10px">åœ¨è©¦ç®—è¡¨ä¸­é»é¸ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€ï¼Œå°‡ Code.gs è£¡çš„å…§å®¹å…¨éƒ¨åˆªé™¤ï¼Œè²¼ä¸Šä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š</p>
          <div style="position:relative">
            <div class="code-block" id="apps-script-code">const HEADERS = {
  companies: ['id','name','industry','size','phone','email','website','owner','address','notes','createdAt','updatedAt'],
  contacts:  ['id','companyId','name','title','dept','phone','email','line','notes','createdAt'],
  deals:     ['id','companyId','contactId','title','dealType','value','stage','expectedCloseDate','actualCloseDate','notes','archived','createdAt'],
  interactions:['id','companyId','contactId','type','date','subject','notes','createdBy','createdAt'],
  tasks:     ['id','companyId','contactId','title','dueDate','priority','status','notes','createdAt'],
  projects:  ['id','dealId','companyId','title','startDate','endDate','status','progress','budget','actualCost','milestones','notes','createdAt'],
  targets:   ['owner','year','quarter','amount']
};

function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const data = {};
    Object.keys(HEADERS).forEach(n => data[n] = readSheet(ss, n));
    return out({success:true, data});
  } catch(e) { return out({success:false, error:e.toString()}); }
}

function doPost(e) {
  try {
    const d = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    Object.keys(HEADERS).forEach(n => { if(d[n] !== undefined) writeSheet(ss, n, d[n]); });
    return out({success:true});
  } catch(e) { return out({success:false, error:e.toString()}); }
}

function readSheet(ss, name) {
  const h = HEADERS[name];
  let s = ss.getSheetByName(name);
  if (!s) { initSheet(ss, name, h); return []; }
  const lr = s.getLastRow();
  if (lr < 2) return [];
  const vals = s.getRange(2, 1, lr-1, h.length).getValues();
  return vals.map(r => {
    const o = {};
    h.forEach((k,i) => { if(r[i] !== '') o[k] = String(r[i]); });
    return o;
  }).filter(r => r.id);
}

function writeSheet(ss, name, rows) {
  const h = HEADERS[name];
  let s = ss.getSheetByName(name);
  if (!s) s = initSheet(ss, name, h);
  const lr = s.getLastRow();
  if (lr > 1) s.getRange(2,1,lr-1,h.length).clearContent();
  if (!rows || !rows.length) return;
  s.getRange(2,1,rows.length,h.length).setValues(rows.map(r => h.map(k => r[k]||'')));
}

function initSheet(ss, name, h) {
  let s = ss.getSheetByName(name);
  if (!s) s = ss.insertSheet(name);
  const hRange = s.getRange(1,1,1,h.length);
  hRange.setValues([h]).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('#ffffff');
  s.setFrozenRows(1);
  return s;
}

function out(d) {
  return ContentService.createTextOutput(JSON.stringify(d))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
            <button class="copy-btn" onclick="copyCode()">ğŸ“‹ è¤‡è£½</button>
          </div>
        </div>
      </div>

      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">3</span>éƒ¨ç½²ç‚ºç¶²è·¯æ‡‰ç”¨ç¨‹å¼</div>
        <div class="setup-step-body" style="font-size:13px;color:var(--gray-600);line-height:1.9">
          â‘  è²¼ä¸Šç¨‹å¼ç¢¼å¾Œï¼Œé»å³ä¸Šè§’ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€<br>
          â‘¡ é»é½’è¼ªåœ–ç¤ºï¼Œé¡å‹é¸ã€Œ<strong>ç¶²è·¯æ‡‰ç”¨ç¨‹å¼</strong>ã€<br>
          â‘¢ã€Œä»¥ä¸‹åˆ—èº«åˆ†åŸ·è¡Œã€é¸ã€Œ<strong>æˆ‘ï¼ˆæ‚¨çš„ Google å¸³æˆ¶ï¼‰</strong>ã€<br>
          â‘£ã€Œèª°å¯ä»¥å­˜å–ã€é¸ã€Œ<strong>æ‰€æœ‰äºº</strong>ï¼ˆåŒ…æ‹¬åŒ¿åï¼‰ã€<br>
          â‘¤ é»ã€Œéƒ¨ç½²ã€ï¼Œè¤‡è£½ç”¢ç”Ÿçš„ç¶²å€ï¼ˆé¡ä¼¼ https://script.google.com/macros/s/xxx/execï¼‰
        </div>
      </div>

      <div class="setup-step">
        <div class="setup-step-title"><span class="setup-step-num">4</span>è²¼ä¸Šç¶²å€ä¸¦é€£ç·š</div>
        <div class="setup-step-body">
          <div class="form-group" style="margin-bottom:10px">
            <label class="form-label">Google Apps Script ç¶²å€</label>
            <input class="form-input" id="script-url-input" placeholder="https://script.google.com/macros/s/AKfycb.../exec">
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary btn-sm" onclick="testConnection()">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
            <button class="btn btn-primary btn-sm" onclick="saveScriptUrl()">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥</button>
            <button class="btn btn-sm" style="color:var(--danger);border-color:var(--gray-200)" onclick="clearScriptUrl()">âœ• æ¸…é™¤è¨­å®š</button>
          </div>
          <div id="test-result" style="margin-top:10px;font-size:13px"></div>
        </div>
      </div>

      <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:14px 16px;margin-bottom:12px">
        <div style="font-size:13px;font-weight:700;color:#15803d;margin-bottom:6px">ğŸ”¢ æ•´ç†ç¾æœ‰è³‡æ–™ ID</div>
        <p style="font-size:12px;color:var(--gray-600);margin-bottom:10px">å°‡æ‰€æœ‰ç¾æœ‰è³‡æ–™çš„äº‚ç¢¼ ID çµ±ä¸€æ›æˆæœ‰è¦å‰‡çš„æ ¼å¼ï¼ˆC-0001ã€P-0001 ç­‰ï¼‰ï¼Œä¸¦è‡ªå‹•æ›´æ–°æ‰€æœ‰é—œè¯ã€‚</p>
        <button class="btn btn-secondary btn-sm" onclick="migrateIds()">ğŸ”„ åŸ·è¡Œ ID æ•´ç†</button>
      </div>
      <div class="alert-warning">
        âš ï¸ è«‹æ³¨æ„ï¼šã€Œèª°å¯ä»¥å­˜å–ã€é¸ã€Œæ‰€æœ‰äººã€ä»£è¡¨ä»»ä½•çŸ¥é“ç¶²å€çš„äººéƒ½å¯ä»¥è®€å–è³‡æ–™ã€‚è‹¥éœ€è¦æ›´åš´æ ¼çš„å®‰å…¨æ§ç®¡ï¼Œè«‹è«®è©¢ IT äººå“¡ã€‚
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('settingsModal')">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Company Modal -->
<div class="modal-overlay" id="companyModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="companyModalTitle">æ–°å¢å…¬å¸</span><button class="modal-close" onclick="closeModal('companyModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full"><label class="form-label">å…¬å¸åç¨± *</label><input class="form-input" id="co-name"></div>
        <div class="form-group"><label class="form-label">ç”¢æ¥­åˆ¥</label><select class="form-select" id="co-industry"><option value="">â€” è«‹é¸æ“‡ â€”</option><option>è£½é€ æ¥­</option><option>ç§‘æŠ€æ¥­</option><option>è²¿æ˜“æ¥­</option><option>é‡‘èæ¥­</option><option>æœå‹™æ¥­</option><option>å»ºè¨­æ¥­</option><option>å€‹äººä½å®…</option><option>é£¯åº—æ—…å®¿</option><option>å…¶ä»–</option></select></div>
        <div class="form-group"><label class="form-label">å…¬å¸è¦æ¨¡</label><select class="form-select" id="co-size"><option value="">â€” è«‹é¸æ“‡ â€”</option><option>å€‹äºº</option><option>1-10 äºº</option><option>11-50 äºº</option><option>51-200 äºº</option><option>201-1000 äºº</option><option>1000+ äºº</option></select></div>
        <div class="form-group"><label class="form-label">é›»è©±</label><input class="form-input" id="co-phone"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="co-email" type="email"></div>
        <div class="form-group"><label class="form-label">ç¶²ç«™</label><input class="form-input" id="co-website" placeholder="https://..."></div>
        <div class="form-group"><label class="form-label">è² è²¬æ¥­å‹™</label><input class="form-input" id="co-owner"></div>
        <div class="form-group form-full"><label class="form-label">åœ°å€</label><input class="form-input" id="co-address"></div>
        <div class="form-group form-full"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="co-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('companyModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveCompany()">å„²å­˜</button></div>
  </div>
</div>

<!-- Contact Modal -->
<div class="modal-overlay" id="contactModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="contactModalTitle">æ–°å¢è¯çµ¡äºº</span><button class="modal-close" onclick="closeModal('contactModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">å§“å *</label><input class="form-input" id="ct-name"></div>
        <div class="form-group"><label class="form-label">æ‰€å±¬å…¬å¸ *</label><input class="form-input" id="ct-company-search" placeholder="æœå°‹å…¬å¸åç¨±..." oninput="filterCoSelect(this.value)" style="margin-bottom:6px"><select class="form-select" id="ct-company"></select></div>
        <div class="form-group"><label class="form-label">è·ç¨±</label><input class="form-input" id="ct-title"></div>
        <div class="form-group"><label class="form-label">éƒ¨é–€</label><input class="form-input" id="ct-dept"></div>
        <div class="form-group"><label class="form-label">é›»è©±</label><input class="form-input" id="ct-phone"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="ct-email" type="email"></div>
        <div class="form-group"><label class="form-label">LINE ID</label><input class="form-input" id="ct-line" placeholder="ä¾‹ï¼š@company_line"></div>
        <div class="form-group form-full"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="ct-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('contactModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveContact()">å„²å­˜</button></div>
  </div>
</div>

<!-- Deal Modal -->
<div class="modal-overlay" id="dealModal">
  <div class="modal modal-lg">
    <div class="modal-header"><span class="modal-title" id="dealModalTitle">æ–°å¢å•†æ©Ÿ</span><button class="modal-close" onclick="closeModal('dealModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full"><label class="form-label">å•†æ©Ÿåç¨± *</label><input class="form-input" id="dl-title"></div>
        <div class="form-group"><label class="form-label">å®¢æˆ¶å…¬å¸ *</label><select class="form-select" id="dl-company" onchange="updateContactsForDeal()"></select></div>
        <div class="form-group"><label class="form-label">ä¸»è¦è¯çµ¡äºº</label><select class="form-select" id="dl-contact"><option value="">â€” ç„¡ â€”</option></select></div>
        <div class="form-group"><label class="form-label">æ´»å‹•é¡å‹</label><select class="form-select" id="dl-type"><option value="">â€” æœªåˆ†é¡ â€”</option><option value="æ‹›å‹Ÿç¶“éŠ·å•†">ğŸ¤ æ‹›å‹Ÿç¶“éŠ·å•†</option><option value="èªè­‰æŠ€è¡“å£«">ğŸ“ èªè­‰æŠ€è¡“å£«</option><option value="ä¾¿åˆ©çš„å°ˆæ¡ˆ">ğŸ”§ ä¾¿åˆ©çš„å°ˆæ¡ˆ</option></select></div>
        <div class="form-group"><label class="form-label">é ä¼°é‡‘é¡ (NT$)</label><input class="form-input" id="dl-value" type="number"></div>
        <div class="form-group"><label class="form-label">éšæ®µ</label><select class="form-select" id="dl-stage"><option value="0">åˆæ­¥æ¥è§¸</option><option value="1">éœ€æ±‚è©•ä¼°</option><option value="2">ææ¡ˆå ±åƒ¹</option><option value="3">è«‡åˆ¤ä¸­</option><option value="4">æˆäº¤</option><option value="5">å¤±å–®</option></select></div>
        <div class="form-group"><label class="form-label">é è¨ˆæˆäº¤æ—¥æœŸ</label><input class="form-input" id="dl-close" type="date"></div>
        <div class="form-group"><label class="form-label">å¯¦éš›æˆäº¤æ—¥æœŸ</label><input class="form-input" id="dl-actual-close" type="date"><div class="form-hint">æˆäº¤å¾Œå¡«å¯«ï¼Œç”¨æ–¼å­£åº¦/å¹´åº¦æ¥­ç¸¾çµ±è¨ˆ</div></div>
        <div class="form-group form-full"><label class="form-label">æè¿°</label><textarea class="form-textarea" id="dl-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('dealModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveDeal()">å„²å­˜</button></div>
  </div>
</div>

<!-- Interaction Modal -->
<div class="modal-overlay" id="intModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="intModalTitle">æ–°å¢äº’å‹•è¨˜éŒ„</span><button class="modal-close" onclick="closeModal('intModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">äº’å‹•é¡å‹</label><select class="form-select" id="int-type"><option value="call">ğŸ“ é›»è©±</option><option value="email">ğŸ“§ Email</option><option value="meeting">ğŸ¤ æœƒè­°</option><option value="visit">ğŸš— æ‹œè¨ª</option><option value="other">ğŸ’¬ å…¶ä»–</option></select></div>
        <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input class="form-input" id="int-date" type="date"></div>
        <div class="form-group"><label class="form-label">å®¢æˆ¶å…¬å¸ *</label><select class="form-select" id="int-company" onchange="updateContactsForInt()"></select></div>
        <div class="form-group"><label class="form-label">è¯çµ¡äºº</label><select class="form-select" id="int-contact"><option value="">â€” ç„¡ â€”</option></select></div>
        <div class="form-group form-full"><label class="form-label">ä¸»æ—¨ *</label><input class="form-input" id="int-subject"></div>
        <div class="form-group form-full"><label class="form-label">è¨˜éŒ„å…§å®¹</label><textarea class="form-textarea" id="int-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('intModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveInteraction()">å„²å­˜</button></div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-header"><span class="modal-title" id="taskModalTitle">æ–°å¢ä»»å‹™</span><button class="modal-close" onclick="closeModal('taskModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full"><label class="form-label">ä»»å‹™åç¨± *</label><input class="form-input" id="tk-title"></div>
        <div class="form-group"><label class="form-label">æˆªæ­¢æ—¥æœŸ</label><input class="form-input" id="tk-due" type="date"></div>
        <div class="form-group"><label class="form-label">å„ªå…ˆç´š</label><select class="form-select" id="tk-priority"><option value="high">ğŸ”´ é«˜</option><option value="med" selected>ğŸŸ¡ ä¸­</option><option value="low">ğŸŸ¢ ä½</option></select></div>
        <div class="form-group"><label class="form-label">ç›¸é—œå…¬å¸</label><select class="form-select" id="tk-company"><option value="">â€” ç„¡ â€”</option></select></div>
        <div class="form-group"><label class="form-label">ç›¸é—œè¯çµ¡äºº</label><select class="form-select" id="tk-contact"><option value="">â€” ç„¡ â€”</option></select></div>
        <div class="form-group form-full"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="tk-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('taskModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveTask()">å„²å­˜</button></div>
  </div>
</div>

<!-- Project Modal -->
<div class="modal-overlay" id="projectModal">
  <div class="modal modal-lg">
    <div class="modal-header"><span class="modal-title" id="projectModalTitle">æ–°å¢å°ˆæ¡ˆ</span><button class="modal-close" onclick="closeModal('projectModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group form-full"><label class="form-label">å°ˆæ¡ˆåç¨± *</label><input class="form-input" id="prj-title"></div>
        <div class="form-group"><label class="form-label">é€£çµå•†æ©Ÿ</label><select class="form-select" id="prj-deal"><option value="">â€” ç„¡ â€”</option></select></div>
        <div class="form-group"><label class="form-label">å®¢æˆ¶å…¬å¸ *</label><select class="form-select" id="prj-company"></select></div>
        <div class="form-group"><label class="form-label">é–‹å·¥æ—¥æœŸ</label><input class="form-input" id="prj-start" type="date"></div>
        <div class="form-group"><label class="form-label">é è¨ˆå®Œå·¥æ—¥</label><input class="form-input" id="prj-end" type="date"></div>
        <div class="form-group"><label class="form-label">å°ˆæ¡ˆç‹€æ…‹</label><select class="form-select" id="prj-status"><option value="active">ğŸ”¨ é€²è¡Œä¸­</option><option value="paused">â¸ æš«åœ</option><option value="completed">âœ… å·²å®Œå·¥</option></select></div>
        <div class="form-group"><label class="form-label">é€²åº¦ (%)</label><input class="form-input" id="prj-progress" type="number" min="0" max="100" placeholder="0~100"></div>
        <div class="form-group"><label class="form-label">åˆç´„é‡‘é¡ (NT$)</label><input class="form-input" id="prj-budget" type="number"></div>
        <div class="form-group"><label class="form-label">å·²ç™¼ç”Ÿè²»ç”¨ (NT$)</label><input class="form-input" id="prj-cost" type="number"></div>
        <div class="form-group form-full"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="prj-notes"></textarea></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('projectModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveProject()">å„²å­˜</button></div>
  </div>
</div>

<!-- Milestone Modal -->
<div class="modal-overlay" id="milestoneModal">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><span class="modal-title">æ–°å¢é‡Œç¨‹ç¢‘</span><button class="modal-close" onclick="closeModal('milestoneModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:12px"><label class="form-label">é‡Œç¨‹ç¢‘åç¨± *</label><input class="form-input" id="ms-title" placeholder="ä¾‹ï¼šå‚™æ–™å®Œæˆã€çµæ§‹é©—æ”¶"></div>
      <div class="form-group"><label class="form-label">ç›®æ¨™æ—¥æœŸ</label><input class="form-input" id="ms-due" type="date"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('milestoneModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveMilestone()">æ–°å¢</button></div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:380px">
    <div class="modal-header"><span class="modal-title">ç¢ºèªåˆªé™¤</span><button class="modal-close" onclick="closeModal('confirmModal')">âœ•</button></div>
    <div class="modal-body"><p id="confirm-msg" style="color:var(--gray-700);font-size:14px">ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('confirmModal')">å–æ¶ˆ</button><button class="btn btn-danger" id="confirm-ok-btn">ç¢ºå®šåˆªé™¤</button></div>
  </div>
</div>

<script>
// ==================== CONFIG & STATE ====================
const STORE_KEY = 'crm_data_v2';
const CONFIG_KEY = 'crm_config_v2';
let db = { companies:[], contacts:[], deals:[], interactions:[], tasks:[], targets:[], projects:[] };
let config = { scriptUrl:'', userName:'', userInitial:'' };
let editingId = null;
let currentPage = 'dashboard';
let saveTimer = null;
let isSyncing = false;

// ==================== CONFIG ====================
function loadConfig() {
  try { const s = localStorage.getItem(CONFIG_KEY); if(s) config = {...config,...JSON.parse(s)}; } catch(e){}
}
function saveConfig() { localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); }

function updateUserDisplay() {
  const name = config.userName || 'è¨­å®šå§“å';
  const init = config.userName ? config.userName.slice(0,1) : 'æˆ‘';
  document.getElementById('user-name-display').textContent = name;
  document.getElementById('user-avatar').textContent = init;
}

function saveSelfName() {
  const n = document.getElementById('self-name').value.trim();
  if (!n) { toast('è«‹è¼¸å…¥æ‚¨çš„å§“å','error'); return; }
  config.userName = n;
  saveConfig();
  updateUserDisplay();
  closeModal('selfModal');
  toast('å§“åå·²è¨­å®šï¼š' + n);
}

// ==================== DATA ====================
function loadLocalDB() {
  try { const s = localStorage.getItem(STORE_KEY); if(s) db = JSON.parse(s); } catch(e){}
}
function saveLocalDB() { localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

// ==================== SYNC ====================
function setSyncStatus(status, msg) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  const map = {
    offline: 'ğŸ’¾ æœ¬æ©Ÿæ¨¡å¼',
    syncing: 'ğŸ”„ åŒæ­¥ä¸­...',
    synced:  'â˜ å·²åŒæ­¥',
    error:   'âš ï¸ åŒæ­¥å¤±æ•—'
  };
  el.textContent = msg || map[status] || status;
  const colorMap = { syncing:'var(--warning)', synced:'var(--success)', error:'var(--danger)', offline:'var(--gray-400)' };
  el.style.color = colorMap[status] || 'var(--gray-400)';
}

async function syncFromSheets() {
  if (!config.scriptUrl) { setSyncStatus('offline'); return; }
  setSyncStatus('syncing');
  try {
    const res = await fetch(config.scriptUrl + '?action=get', { redirect:'follow' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if (json.success && json.data) {
      db = { companies:[], contacts:[], deals:[], interactions:[], tasks:[], targets:[], projects:[], ...json.data };
      saveLocalDB();
      setSyncStatus('synced');
      updateTaskBadge();
      render();
    } else { throw new Error(json.error || 'è³‡æ–™æ ¼å¼éŒ¯èª¤'); }
  } catch(e) {
    setSyncStatus('error', 'âš ï¸ åŒæ­¥å¤±æ•—ï¼ˆé»æ“Šé‡è©¦ï¼‰');
    console.error('Sync from sheets error:', e);
  }
}

async function syncToSheets() {
  if (!config.scriptUrl || isSyncing) return;
  isSyncing = true;
  setSyncStatus('syncing');
  try {
    const res = await fetch(config.scriptUrl, {
      method: 'POST',
      body: JSON.stringify(db),
      redirect: 'follow',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if (json.success) setSyncStatus('synced');
    else throw new Error(json.error);
  } catch(e) {
    setSyncStatus('error', 'âš ï¸ åŒæ­¥å¤±æ•—ï¼ˆé»æ“Šé‡è©¦ï¼‰');
    console.error('Sync to sheets error:', e);
  } finally { isSyncing = false; }
}

function saveDB() {
  saveLocalDB();
  updateTaskBadge();
  clearTimeout(saveTimer);
  if (config.scriptUrl) saveTimer = setTimeout(syncToSheets, 1200);
}

function manualSync() {
  if (!config.scriptUrl) { openModal('settingsModal'); return; }
  syncFromSheets();
}

// ==================== SETTINGS MODAL ====================
function openSettingsModal() {
  document.getElementById('script-url-input').value = config.scriptUrl || '';
  updateSettingsStatus();
}

function updateSettingsStatus() {
  const bar = document.getElementById('settings-status-bar');
  if (!bar) return;
  if (config.scriptUrl) {
    bar.innerHTML = `<div style="background:#dcfce7;border:1px solid #86efac;border-radius:8px;padding:10px 14px;font-size:13px;color:#15803d">âœ… å·²é€£ç·šï¼š<code style="font-size:12px">${config.scriptUrl.slice(0,60)}...</code></div>`;
  } else {
    bar.innerHTML = `<div class="alert-info">â¬‡ï¸ è«‹å®Œæˆä»¥ä¸‹æ­¥é©Ÿä¾†å•Ÿç”¨ Google Sheets é›²ç«¯åŒæ­¥åŠŸèƒ½ã€‚</div>`;
  }
}

function copyCode() {
  const code = document.getElementById('apps-script-code').textContent;
  navigator.clipboard.writeText(code).then(() => toast('ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼'));
}

async function testConnection() {
  const url = document.getElementById('script-url-input').value.trim();
  if (!url) { document.getElementById('test-result').innerHTML = '<span style="color:var(--danger)">è«‹è¼¸å…¥ç¶²å€</span>'; return; }
  document.getElementById('test-result').innerHTML = 'ğŸ”„ æ¸¬è©¦ä¸­...';
  try {
    const res = await fetch(url + '?action=get', { redirect:'follow' });
    const json = await res.json();
    if (json.success !== undefined) {
      document.getElementById('test-result').innerHTML = '<span style="color:var(--success)">âœ… é€£ç·šæˆåŠŸï¼é»ã€Œå„²å­˜ä¸¦åŒæ­¥ã€å®Œæˆè¨­å®šã€‚</span>';
    } else { throw new Error('å›æ‡‰æ ¼å¼ä¸æ­£ç¢º'); }
  } catch(e) {
    document.getElementById('test-result').innerHTML = `<span style="color:var(--danger)">âŒ é€£ç·šå¤±æ•—ï¼š${e.message}ã€‚è«‹ç¢ºèªç¶²å€æ­£ç¢ºï¼Œä¸”å·²é¸ã€Œæ‰€æœ‰äººã€å­˜å–ã€‚</span>`;
  }
}

async function saveScriptUrl() {
  const url = document.getElementById('script-url-input').value.trim();
  if (!url) { toast('è«‹è¼¸å…¥ Apps Script ç¶²å€', 'error'); return; }
  config.scriptUrl = url;
  saveConfig();
  updateSettingsStatus();
  closeModal('settingsModal');
  toast('è¨­å®šå·²å„²å­˜ï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™...');
  await syncFromSheets();
}

function clearScriptUrl() {
  config.scriptUrl = '';
  saveConfig();
  document.getElementById('script-url-input').value = '';
  updateSettingsStatus();
  setSyncStatus('offline');
  toast('é›²ç«¯è¨­å®šå·²æ¸…é™¤ï¼Œåˆ‡æ›ç‚ºæœ¬æ©Ÿæ¨¡å¼');
}

// ==================== NAVIGATION ====================
function navigate(page) {
  currentProjectId = null;
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const pages = ['dashboard','companies','contacts','pipeline','interactions','tasks','massemail','salesstats','projects'];
  const navItems = document.querySelectorAll('.nav-item');
  const idx = pages.indexOf(page);
  if (idx >= 0) navItems[idx]?.classList.add('active');
  const titles = { dashboard:'å„€è¡¨æ¿', companies:'å…¬å¸å®¢æˆ¶', contacts:'è¯çµ¡äºº', pipeline:'æ¥­å‹™ç®¡é“', interactions:'äº’å‹•è¨˜éŒ„', tasks:'ä»»å‹™æé†’', massemail:'ç¾¤ç™¼éƒµä»¶', salesstats:'æ¥­ç¸¾çµ±è¨ˆ', projects:'å°ˆæ¡ˆç®¡ç†' };
  document.getElementById('page-title').textContent = titles[page] || page;
  render();
}

function handleAddBtn() {
  const map = { companies:'companyModal', contacts:'contactModal', pipeline:'dealModal', interactions:'intModal', tasks:'taskModal', projects:'projectModal' };
  const modal = map[currentPage];
  if (modal) { editingId = null; openModal(modal); }
}

// ==================== MODALS ====================
function openModal(id) {
  document.getElementById(id).classList.add('open');
  if (id==='companyModal') resetCompanyModal();
  if (id==='contactModal') resetContactModal();
  if (id==='dealModal') resetDealModal();
  if (id==='intModal') resetIntModal();
  if (id==='taskModal') resetTaskModal();
  if (id==='projectModal') resetProjectModal();
  if (id==='selfModal') { document.getElementById('self-name').value = config.userName || ''; }
  if (id==='settingsModal') openSettingsModal();
  if (id==='usersModal') renderUsersModal();
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); editingId = null; }
document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', e => { if(e.target===el) closeModal(el.id); }));

function renderUsersModal() {
  const users = [...new Set(db.interactions.filter(i=>i.createdBy).map(i=>i.createdBy))];
  const el = document.getElementById('active-users-list');
  el.innerHTML = `<div class="section-title" style="font-size:12px;font-weight:700;color:var(--gray-500);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">æœ€è¿‘çš„ä½¿ç”¨ç´€éŒ„ï¼ˆä¾äº’å‹•è¨˜éŒ„ï¼‰</div>` +
    (users.length === 0 ? '<div style="color:var(--gray-400);font-size:13px">å°šç„¡è¨˜éŒ„</div>' :
    users.map(u => {
      const count = db.interactions.filter(i=>i.createdBy===u).length;
      const init = u.slice(0,1);
      return `<div class="user-list-item">
        <div class="user-avatar" style="width:30px;height:30px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;font-weight:700">${init}</div>
        <div>
          <div style="font-size:13.5px;font-weight:600">${escHtml(u)}</div>
          <div style="font-size:12px;color:var(--gray-500)">å»ºç«‹äº† ${count} ç­†äº’å‹•è¨˜éŒ„</div>
        </div>
      </div>`;
    }).join(''));
}

// ==================== UTILS ====================
const STAGES = ['åˆæ­¥æ¥è§¸','éœ€æ±‚è©•ä¼°','ææ¡ˆå ±åƒ¹','è«‡åˆ¤ä¸­','æˆäº¤','å¤±å–®'];
// ç›¸å®¹æ–°æ ¼å¼ï¼ˆæ•¸å­— 0-5ï¼‰èˆ‡èˆŠæ ¼å¼ï¼ˆä¸­æ–‡åç¨±å­—ä¸²ï¼‰
function stageIdx(s) {
  const n = parseInt(s);
  return isNaN(n) ? STAGES.indexOf(String(s)) : n;
}
const INT_ICONS = { call:'ğŸ“', email:'ğŸ“§', meeting:'ğŸ¤', visit:'ğŸš—', other:'ğŸ’¬' };
const INT_COLORS = { call:'#dbeafe', email:'#dcfce7', meeting:'#f3e8ff', visit:'#ffedd5', other:'#f1f5f9' };

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function genId(type) {
  const prefixes = { companies:'C', contacts:'P', deals:'D', interactions:'I', tasks:'T', projects:'PRJ' };
  const prefix = prefixes[type] || 'X';
  const items = db[type] || [];
  let max = 0;
  items.forEach(item => {
    const m = item.id && item.id.match(new RegExp('^' + prefix + '-(\\d+)$'));
    if (m) max = Math.max(max, parseInt(m[1]));
  });
  return prefix + '-' + String(max + 1).padStart(4, '0');
}
function normalizeDate(d) {
  if (!d) return d;
  if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
  const parsed = new Date(d);
  if (isNaN(parsed)) return d;
  return parsed.toISOString().split('T')[0];
}
function migrateIds() {
  const pad = n => String(n).padStart(4,'0');
  const maps = { companies:{}, contacts:{}, deals:{}, interactions:{}, tasks:{} };
  const prefixes = { companies:'C', contacts:'P', deals:'D', interactions:'I', tasks:'T' };
  Object.keys(maps).forEach(type => {
    db[type].forEach((item, i) => {
      maps[type][item.id] = prefixes[type] + '-' + pad(i+1);
    });
  });
  db.companies.forEach(x => {
    x.id = maps.companies[x.id] || x.id;
    x.createdAt = normalizeDate(x.createdAt);
    x.updatedAt = normalizeDate(x.updatedAt);
  });
  db.contacts.forEach(x => {
    x.id = maps.contacts[x.id] || x.id;
    x.companyId = maps.companies[x.companyId] || x.companyId;
    x.createdAt = normalizeDate(x.createdAt);
  });
  db.deals.forEach(x => {
    x.id = maps.deals[x.id] || x.id;
    x.companyId = maps.companies[x.companyId] || x.companyId;
    x.contactId = maps.contacts[x.contactId] || x.contactId;
    x.createdAt = normalizeDate(x.createdAt);
    x.expectedCloseDate = normalizeDate(x.expectedCloseDate);
  });
  db.interactions.forEach(x => {
    x.id = maps.interactions[x.id] || x.id;
    x.companyId = maps.companies[x.companyId] || x.companyId;
    x.contactId = maps.contacts[x.contactId] || x.contactId;
    x.date = normalizeDate(x.date);
    x.createdAt = normalizeDate(x.createdAt);
  });
  db.tasks.forEach(x => {
    x.id = maps.tasks[x.id] || x.id;
    x.companyId = maps.companies[x.companyId] || x.companyId;
    x.contactId = maps.contacts[x.contactId] || x.contactId;
    x.dueDate = normalizeDate(x.dueDate);
    x.createdAt = normalizeDate(x.createdAt);
  });
  saveDB();
  render();
  toast('âœ… ID æ•´ç†å®Œæˆï¼Œæ—¥æœŸæ ¼å¼å·²çµ±ä¸€ï¼');
}
function today() { return new Date().toISOString().split('T')[0]; }
function fmt(d) {
  if(!d) return 'â€”';
  var s = String(d).trim();
  var iso = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
  if(iso) return iso[1]+'/'+iso[2].padStart(2,'0')+'/'+iso[3].padStart(2,'0');
  var dt = new Date(s);
  if(!isNaN(dt.getTime())) return dt.getFullYear()+'/'+(dt.getMonth()+1).toString().padStart(2,'0')+'/'+dt.getDate().toString().padStart(2,'0');
  return s;
}
function fmtMoney(v) { if(!v) return 'â€”'; return 'NT$ '+Number(v).toLocaleString(); }
function daysDiff(d) { if(!d) return null; return Math.ceil((new Date(d)-new Date(today()))/86400000); }
function escHtml(s) { if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function currentUser() { return config.userName || 'æœªçŸ¥ä½¿ç”¨è€…'; }

function populateCompanySelect(id, allowEmpty) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = (allowEmpty?'<option value="">â€” ç„¡ â€”</option>':'') +
    db.companies.map(c=>`<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
}

function resetCompanyModal() {
  const f=['name','industry','size','phone','email','website','owner','address','notes'];
  f.forEach(k=>{ const el=document.getElementById('co-'+k); if(el) el.value=''; });
  document.getElementById('companyModalTitle').textContent = editingId?'ç·¨è¼¯å…¬å¸':'æ–°å¢å…¬å¸';
  if (editingId) { const c=db.companies.find(x=>x.id===editingId); if(c) f.forEach(k=>{ const el=document.getElementById('co-'+k); if(el) el.value=c[k]||''; }); }
}
function resetContactModal() {
  document.getElementById('contactModalTitle').textContent = editingId?'ç·¨è¼¯è¯çµ¡äºº':'æ–°å¢è¯çµ¡äºº';
  populateCompanySelect('ct-company',false);
  ['name','title','dept','phone','email','line','notes'].forEach(k=>{ const el=document.getElementById('ct-'+k); if(el) el.value=''; });
  const csEl=document.getElementById('ct-company-search'); if(csEl) csEl.value='';
  if (editingId) { const c=db.contacts.find(x=>x.id===editingId); if(c){ ['name','title','dept','phone','email','line','notes'].forEach(k=>{ const el=document.getElementById('ct-'+k); if(el) el.value=c[k]||''; }); document.getElementById('ct-company').value=c.companyId||''; const csEl2=document.getElementById('ct-company-search'); if(csEl2){ const co=db.companies.find(x=>x.id===c.companyId); csEl2.value=co?co.name:''; } } }
}
function resetDealModal() {
  document.getElementById('dealModalTitle').textContent = editingId?'ç·¨è¼¯å•†æ©Ÿ':'æ–°å¢å•†æ©Ÿ';
  populateCompanySelect('dl-company',false);
  ['title','value','notes'].forEach(k=>{ const el=document.getElementById('dl-'+k); if(el) el.value=''; });
  document.getElementById('dl-stage').value='0';
  document.getElementById('dl-close').value='';
  document.getElementById('dl-actual-close').value='';
  document.getElementById('dl-type').value='';
  updateContactsForDeal();
  if (editingId) {
    const d=db.deals.find(x=>x.id===editingId); if(d){
      ['title','value','notes'].forEach(k=>{ const el=document.getElementById('dl-'+k); if(el) el.value=d[k]||''; });
      document.getElementById('dl-company').value=d.companyId||'';
      document.getElementById('dl-stage').value=stageIdx(d.stage??0);
      document.getElementById('dl-close').value=d.expectedCloseDate||'';
      document.getElementById('dl-actual-close').value=d.actualCloseDate||'';
      document.getElementById('dl-type').value=d.dealType||'';
      updateContactsForDeal();
      setTimeout(()=>{ document.getElementById('dl-contact').value=d.contactId||''; },50);
    }
  }
}
function resetIntModal() {
  document.getElementById('intModalTitle').textContent = editingId?'ç·¨è¼¯è¨˜éŒ„':'æ–°å¢äº’å‹•è¨˜éŒ„';
  populateCompanySelect('int-company',false);
  ['subject','notes'].forEach(k=>{ const el=document.getElementById('int-'+k); if(el) el.value=''; });
  document.getElementById('int-type').value='call';
  document.getElementById('int-date').value=today();
  updateContactsForInt();
  if (editingId) {
    const i=db.interactions.find(x=>x.id===editingId); if(i){
      ['type','date','subject','notes'].forEach(k=>{ const el=document.getElementById('int-'+k); if(el) el.value=i[k]||''; });
      document.getElementById('int-company').value=i.companyId||'';
      updateContactsForInt();
      setTimeout(()=>{ document.getElementById('int-contact').value=i.contactId||''; },50);
    }
  }
}
function resetTaskModal() {
  document.getElementById('taskModalTitle').textContent = editingId?'ç·¨è¼¯ä»»å‹™':'æ–°å¢ä»»å‹™';
  populateCompanySelect('tk-company',true);
  ['title','notes'].forEach(k=>{ const el=document.getElementById('tk-'+k); if(el) el.value=''; });
  document.getElementById('tk-due').value='';
  document.getElementById('tk-priority').value='med';
  document.getElementById('tk-contact').innerHTML='<option value="">â€” ç„¡ â€”</option>';
  if (editingId) {
    const t=db.tasks.find(x=>x.id===editingId); if(t){
      ['title','notes'].forEach(k=>{ const el=document.getElementById('tk-'+k); if(el) el.value=t[k]||''; });
      document.getElementById('tk-due').value=t.dueDate||'';
      document.getElementById('tk-priority').value=t.priority||'med';
      document.getElementById('tk-company').value=t.companyId||'';
      const ctSel=document.getElementById('tk-contact');
      const cts=db.contacts.filter(c=>c.companyId===t.companyId);
      ctSel.innerHTML='<option value="">â€” ç„¡ â€”</option>'+cts.map(c=>`<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
      ctSel.value=t.contactId||'';
    }
  }
}

function updateContactsForDeal() {
  const cId=document.getElementById('dl-company').value;
  const cts=db.contacts.filter(c=>c.companyId===cId);
  document.getElementById('dl-contact').innerHTML='<option value="">â€” ç„¡ â€”</option>'+cts.map(c=>`<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
}
function updateContactsForInt() {
  const cId=document.getElementById('int-company').value;
  const cts=db.contacts.filter(c=>c.companyId===cId);
  document.getElementById('int-contact').innerHTML='<option value="">â€” ç„¡ â€”</option>'+cts.map(c=>`<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
}

// ==================== SAVE ====================
function saveCompany() {
  const name=document.getElementById('co-name').value.trim();
  if (!name) { toast('è«‹è¼¸å…¥å…¬å¸åç¨±','error'); return; }
  const obj={
    id:editingId||genId('companies'), name,
    industry:document.getElementById('co-industry').value,
    size:document.getElementById('co-size').value,
    phone:document.getElementById('co-phone').value,
    email:document.getElementById('co-email').value,
    website:document.getElementById('co-website').value,
    owner:document.getElementById('co-owner').value,
    address:document.getElementById('co-address').value,
    notes:document.getElementById('co-notes').value,
    createdAt:editingId?(db.companies.find(x=>x.id===editingId)?.createdAt||today()):today(),
    updatedAt:today()
  };
  if (editingId) db.companies=db.companies.map(x=>x.id===editingId?obj:x);
  else db.companies.push(obj);
  saveDB(); closeModal('companyModal'); render(); toast(editingId?'å·²æ›´æ–°å…¬å¸':'å·²æ–°å¢å…¬å¸');
}

function filterCoSelect(term) {
  const s = term.toLowerCase();
  const select = document.getElementById('ct-company');
  const current = select.value;
  const filtered = db.companies.filter(c => !s || c.name.toLowerCase().includes(s)).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
  select.innerHTML = '<option value="">è«‹é¸æ“‡å…¬å¸</option>' + filtered.map(c=>`<option value="${c.id}" ${c.id===current?'selected':''}>${escHtml(c.name)}</option>`).join('');
}
function saveContact() {
  const name=document.getElementById('ct-name').value.trim();
  const companyId=document.getElementById('ct-company').value;
  if (!name) { toast('è«‹è¼¸å…¥å§“å','error'); return; }
  if (!companyId) { toast('è«‹é¸æ“‡æ‰€å±¬å…¬å¸','error'); return; }
  const obj={
    id:editingId||genId('contacts'), name, companyId,
    title:document.getElementById('ct-title').value,
    dept:document.getElementById('ct-dept').value,
    phone:document.getElementById('ct-phone').value,
    email:document.getElementById('ct-email').value,
    line:document.getElementById('ct-line').value,
    notes:document.getElementById('ct-notes').value,
    createdAt:editingId?(db.contacts.find(x=>x.id===editingId)?.createdAt||today()):today()
  };
  if (editingId) db.contacts=db.contacts.map(x=>x.id===editingId?obj:x);
  else db.contacts.push(obj);
  saveDB(); closeModal('contactModal'); render(); toast(editingId?'å·²æ›´æ–°è¯çµ¡äºº':'å·²æ–°å¢è¯çµ¡äºº');
}

function saveDeal() {
  const title=document.getElementById('dl-title').value.trim();
  const companyId=document.getElementById('dl-company').value;
  if (!title) { toast('è«‹è¼¸å…¥å•†æ©Ÿåç¨±','error'); return; }
  if (!companyId) { toast('è«‹é¸æ“‡å®¢æˆ¶å…¬å¸','error'); return; }
  const existing = editingId ? db.deals.find(x=>x.id===editingId) : null;
  const obj={
    id:editingId||genId('deals'), title, companyId,
    dealType:document.getElementById('dl-type').value,
    contactId:document.getElementById('dl-contact').value,
    value:document.getElementById('dl-value').value,
    stage:parseInt(document.getElementById('dl-stage').value),
    expectedCloseDate:document.getElementById('dl-close').value,
    actualCloseDate:document.getElementById('dl-actual-close').value,
    notes:document.getElementById('dl-notes').value,
    archived:existing?.archived||'',
    createdAt:existing?.createdAt||today()
  };
  if (editingId) db.deals=db.deals.map(x=>x.id===editingId?obj:x);
  else db.deals.push(obj);
  saveDB(); closeModal('dealModal'); render(); toast(editingId?'å·²æ›´æ–°å•†æ©Ÿ':'å·²æ–°å¢å•†æ©Ÿ');
}

function saveInteraction() {
  const subject=document.getElementById('int-subject').value.trim();
  const companyId=document.getElementById('int-company').value;
  if (!subject) { toast('è«‹è¼¸å…¥ä¸»æ—¨','error'); return; }
  if (!companyId) { toast('è«‹é¸æ“‡å®¢æˆ¶å…¬å¸','error'); return; }
  const obj={
    id:editingId||genId('interactions'), subject, companyId,
    contactId:document.getElementById('int-contact').value,
    type:document.getElementById('int-type').value,
    date:document.getElementById('int-date').value||today(),
    notes:document.getElementById('int-notes').value,
    createdBy:currentUser(),
    createdAt:today()
  };
  if (editingId) db.interactions=db.interactions.map(x=>x.id===editingId?obj:x);
  else db.interactions.push(obj);
  saveDB(); closeModal('intModal'); render(); toast(editingId?'å·²æ›´æ–°è¨˜éŒ„':'å·²æ–°å¢è¨˜éŒ„');
}

function saveTask() {
  const title=document.getElementById('tk-title').value.trim();
  if (!title) { toast('è«‹è¼¸å…¥ä»»å‹™åç¨±','error'); return; }
  const existing=editingId?db.tasks.find(x=>x.id===editingId):null;
  const obj={
    id:editingId||genId('tasks'), title,
    dueDate:document.getElementById('tk-due').value,
    priority:document.getElementById('tk-priority').value,
    companyId:document.getElementById('tk-company').value,
    contactId:document.getElementById('tk-contact').value,
    notes:document.getElementById('tk-notes').value,
    status:existing?.status||'todo',
    createdAt:existing?.createdAt||today()
  };
  if (editingId) db.tasks=db.tasks.map(x=>x.id===editingId?obj:x);
  else db.tasks.push(obj);
  saveDB(); closeModal('taskModal'); render(); toast(editingId?'å·²æ›´æ–°ä»»å‹™':'å·²æ–°å¢ä»»å‹™');
}

// ==================== DELETE ====================
function confirmDelete(msg,cb) {
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('confirm-ok-btn').onclick=()=>{ cb(); closeModal('confirmModal'); };
  openModal('confirmModal');
}
function deleteCompany(id) { confirmDelete('ç¢ºå®šåˆªé™¤æ­¤å…¬å¸ï¼Ÿç›¸é—œè¯çµ¡äººã€å•†æ©ŸåŠè¨˜éŒ„å°‡ä¸€ä½µç§»é™¤ã€‚',()=>{ db.companies=db.companies.filter(x=>x.id!==id); db.contacts=db.contacts.filter(x=>x.companyId!==id); db.deals=db.deals.filter(x=>x.companyId!==id); db.interactions=db.interactions.filter(x=>x.companyId!==id); db.tasks=db.tasks.filter(x=>x.companyId!==id); saveDB(); render(); toast('å·²åˆªé™¤å…¬å¸'); }); }
function deleteContact(id) { confirmDelete('ç¢ºå®šåˆªé™¤æ­¤è¯çµ¡äººï¼Ÿ',()=>{ db.contacts=db.contacts.filter(x=>x.id!==id); saveDB(); render(); toast('å·²åˆªé™¤è¯çµ¡äºº'); }); }
function archiveDeal(id) {
  const deal = db.deals.find(x=>x.id===id);
  if (!deal) return;
  confirmDelete(
    stageIdx(deal.stage)===4 ? 'å°å­˜æ­¤å•†æ©Ÿï¼Ÿå°å­˜å¾Œä¸æœƒå‡ºç¾åœ¨æ¥­å‹™ç®¡é“ï¼Œä½†æ¥­ç¸¾çµ±è¨ˆä»æœƒè¨ˆå…¥ã€‚' : 'ç¢ºå®šåˆªé™¤æ­¤å•†æ©Ÿï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚',
    function() {
      if (stageIdx(deal.stage)===4) {
        deal.archived = 'true';
        saveDB(); render(); toast('âœ… å•†æ©Ÿå·²å°å­˜');
      } else {
        db.deals = db.deals.filter(x=>x.id!==id);
        saveDB(); render(); toast('å·²åˆªé™¤å•†æ©Ÿ');
      }
    }
  );
}
function deleteDeal(id) { archiveDeal(id); }
function unarchiveDeal(id) {
  var d = db.deals.find(function(x){ return x.id===id; });
  if(d){ d.archived=''; saveDB(); render(); toast('å•†æ©Ÿå·²é‚„åŸ'); }
}
function hardDeleteDeal(id) {
  confirmDelete('æ°¸ä¹…åˆªé™¤æ­¤å•†æ©Ÿï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', function(){
    db.deals = db.deals.filter(function(x){ return x.id!==id; });
    saveDB(); render(); toast('å·²æ°¸ä¹…åˆªé™¤');
  });
}
function buildArchivedSection() {
  var archived = db.deals.filter(function(d){ return d.archived==='true'; });
  if (archived.length===0) return '<div style="flex:0 0 220px;padding:20px;color:var(--gray-400);font-size:12px;text-align:center">ç„¡å°å­˜å•†æ©Ÿ</div>';
  var cards = '';
  archived.forEach(function(d) {
    var co = db.companies.find(function(c){ return c.id===d.companyId; });
    cards += '<div class="pipeline-card" style="opacity:0.6">'
      + '<div class="pipeline-card-title">' + escHtml(d.title) + '</div>'
      + '<div class="pipeline-card-company">ğŸ¢ ' + (co?escHtml(co.name):'â€”') + '</div>'
      + (d.value?'<div class="pipeline-card-value">' + fmtMoney(d.value) + '</div>':'')
      + '<div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">'
      + '<button class="btn btn-xs btn-secondary" onclick="event.stopPropagation();unarchiveDeal(\'' + d.id + '\')">é‚„åŸ</button>'
      + '<button class="btn btn-xs" style="color:var(--danger);border:1px solid var(--gray-200);background:#fff" onclick="event.stopPropagation();hardDeleteDeal(\'' + d.id + '\')">åˆªé™¤</button>'
      + '</div></div>';
  });
  return '<div class="pipeline-col">'
    + '<div class="pipeline-col-header" style="background:#64748b"><span class="pipeline-col-title" style="color:#fff">ğŸ“¦ å°å­˜</span><span class="pipeline-col-count">' + archived.length + '</span></div>'
    + '<div class="pipeline-col-body" style="background:var(--gray-200)">' + cards + '</div>'
    + '</div>';
}
function deleteInteraction(id) { confirmDelete('ç¢ºå®šåˆªé™¤æ­¤äº’å‹•è¨˜éŒ„ï¼Ÿ',()=>{ db.interactions=db.interactions.filter(x=>x.id!==id); saveDB(); render(); toast('å·²åˆªé™¤è¨˜éŒ„'); }); }
function deleteTask(id) { confirmDelete('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ',()=>{ db.tasks=db.tasks.filter(x=>x.id!==id); saveDB(); render(); toast('å·²åˆªé™¤ä»»å‹™'); }); }
function toggleTask(id) {
  const t = db.tasks.find(x=>x.id===id);
  if (!t) return;
  if (t.status === 'done') {
    // å–æ¶ˆå®Œæˆï¼šæ¸…é™¤å€’æ•¸è¨ˆæ™‚å™¨
    if (t._deleteTimer) { clearTimeout(t._deleteTimer); delete t._deleteTimer; }
    t.status = 'todo';
    saveDB(); render();
  } else {
    t.status = 'done';
    saveDB(); render();
    // 3 ç§’å¾Œè‡ªå‹•åˆªé™¤ï¼ŒæœŸé–“å¯é»ã€Œå–æ¶ˆã€
    const timer = setTimeout(function() {
      db.tasks = db.tasks.filter(x=>x.id!==id);
      saveDB(); render(); toast('âœ… ä»»å‹™å·²è‡ªå‹•æ¸…é™¤');
    }, 3000);
    t._deleteTimer = timer;
  }
}
function clearDoneTasks() {
  const count = db.tasks.filter(t=>t.status==='done').length;
  if (count === 0) { toast('æ²’æœ‰å·²å®Œæˆçš„ä»»å‹™','error'); return; }
  db.tasks.filter(t=>t.status==='done').forEach(t=>{ if(t._deleteTimer) clearTimeout(t._deleteTimer); });
  db.tasks = db.tasks.filter(t=>t.status!=='done');
  saveDB(); render(); toast('ğŸ—‘ï¸ å·²æ¸…é™¤ '+count+' ç­†å®Œæˆä»»å‹™');
}

// ==================== RENDER ====================
function updateTaskBadge() {
  const n=db.tasks.filter(t=>t.status==='todo').length;
  const badge=document.getElementById('task-badge');
  badge.style.display=n>0?'':'none';
  badge.textContent=n;
  // update project badge
  var activeProjects = db.projects ? db.projects.filter(function(p){ return p.status !== 'completed'; }).length : 0;
  var pb = document.getElementById('project-badge');
  if(pb){ pb.textContent = activeProjects; pb.style.display = activeProjects > 0 ? '' : 'none'; }
}

function render() {
  const map={ dashboard:renderDashboard, companies:renderCompanies, contacts:renderContacts, pipeline:renderPipeline, interactions:renderInteractions, tasks:renderTasks, massemail:renderMassEmail, salesstats:renderSalesStats, projects:renderProjects };
  (map[currentPage]||renderDashboard)();
  updateTaskBadge();
}

function renderDashboard() {
  const wonDeals=db.deals.filter(d=>stageIdx(d.stage)===4);
  const wonValue=wonDeals.reduce((a,d)=>a+(+d.value||0),0);
  const activeDeal=db.deals.filter(d=>stageIdx(d.stage)!==4&&stageIdx(d.stage)!==5);
  const pendingTasks=db.tasks.filter(t=>t.status==='todo');
  const overdueTasks=pendingTasks.filter(t=>t.dueDate&&daysDiff(t.dueDate)<0);
  const recentInt=[...db.interactions].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,6);
  const upcomingTasks=[...pendingTasks].sort((a,b)=>{ if(!a.dueDate&&!b.dueDate)return 0; if(!a.dueDate)return 1; if(!b.dueDate)return -1; return a.dueDate.localeCompare(b.dueDate); }).slice(0,8);
  document.getElementById('content').innerHTML=`
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon" style="background:#eff6ff">ğŸ¢</div><div class="stat-label">å®¢æˆ¶å…¬å¸æ•¸</div><div class="stat-value">${db.companies.length}</div><div class="stat-sub">${db.contacts.length} ä½è¯çµ¡äºº</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#f0fdf4">ğŸ“ˆ</div><div class="stat-label">é€²è¡Œä¸­å•†æ©Ÿ</div><div class="stat-value">${activeDeal.length}</div><div class="stat-sub">é ä¼° ${fmtMoney(activeDeal.reduce((a,d)=>a+(+d.value||0),0))}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#fefce8">âœ…</div><div class="stat-label">æˆäº¤é‡‘é¡</div><div class="stat-value" style="font-size:20px">${fmtMoney(wonValue)}</div><div class="stat-sub">${wonDeals.length} ç­†æˆäº¤</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#fef2f2">âš ï¸</div><div class="stat-label">å¾…è¾¦ä»»å‹™</div><div class="stat-value">${pendingTasks.length}</div><div class="stat-sub">${overdueTasks.length>0?`<span style="color:var(--danger);font-weight:600">${overdueTasks.length} é …å·²é€¾æœŸ</span>`:'ç„¡é€¾æœŸ'}</div></div>
    </div>
    <div class="dash-grid">
      <div class="card">
        <div class="card-header"><span class="card-title">ğŸ“‹ å¾…è¾¦ä»»å‹™</span><span class="text-link" style="font-size:12px" onclick="navigate('tasks')">æŸ¥çœ‹å…¨éƒ¨ â†’</span></div>
        <div class="card-body" style="padding:0">
          ${upcomingTasks.length===0?'<div class="empty-state" style="padding:30px"><div class="empty-icon">ğŸ‰</div><div class="empty-title">æ²’æœ‰å¾…è¾¦ä»»å‹™</div></div>':
          upcomingTasks.map(t=>{
            const d=t.dueDate?daysDiff(t.dueDate):null;
            const co=db.companies.find(c=>c.id===t.companyId);
            const overdue=d!==null&&d<0;
            const dueTxt=d===null?'':overdue?`<span class="task-overdue">é€¾æœŸ ${Math.abs(d)} å¤©</span>`:d===0?'<span style="color:var(--warning);font-weight:600">ä»Šå¤©åˆ°æœŸ</span>':fmt(t.dueDate)+`ï¼ˆ${d}å¤©å¾Œï¼‰`;
            return`<div class="task-item" style="padding:10px 20px">
              <div class="task-check ${t.status==='done'?'done':''}" onclick="toggleTask('${t.id}')">${t.status==='done'?'âœ“':''}</div>
              <div class="task-content">
                <div class="task-title ${t.status==='done'?'done-text':''}">${escHtml(t.title)}</div>
                <div class="task-meta">${co?`<span>ğŸ¢ ${escHtml(co.name)}</span>`:''} ${dueTxt?`<span>${dueTxt}</span>`:''} <span class="${t.priority==='high'?'pri-high':t.priority==='low'?'pri-low':'pri-med'}">${t.priority==='high'?'é«˜':t.priority==='low'?'ä½':'ä¸­'}å„ªå…ˆ</span></div>
              </div></div>`;
          }).join('')}
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">ğŸ’¬ æœ€æ–°äº’å‹•è¨˜éŒ„</span><span class="text-link" style="font-size:12px" onclick="navigate('interactions')">æŸ¥çœ‹å…¨éƒ¨ â†’</span></div>
        <div class="card-body" style="padding:10px 20px">
          ${recentInt.length===0?'<div class="empty-state" style="padding:20px"><div class="empty-icon">ğŸ“­</div><div class="empty-title">å°šç„¡è¨˜éŒ„</div></div>':
          recentInt.map(i=>{ const co=db.companies.find(c=>c.id===i.companyId); return`<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--gray-100)">
            <span style="font-size:18px;margin-top:2px">${INT_ICONS[i.type]||'ğŸ’¬'}</span>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(i.subject)}</div>
              <div style="font-size:12px;color:var(--gray-500)">${co?escHtml(co.name):''} Â· ${fmt(i.date)} ${i.createdBy?`Â· ${escHtml(i.createdBy)}`:''}</div>
            </div></div>`; }).join('')}
        </div>
      </div>
      <div class="card dash-full">
        <div class="card-header"><span class="card-title">ğŸ“Š Pipeline æ¦‚è¦½</span><span class="text-link" style="font-size:12px" onclick="navigate('pipeline')">ç®¡ç†å•†æ©Ÿ â†’</span></div>
        <div class="card-body"><div style="display:flex;gap:16px;flex-wrap:wrap">
          ${STAGES.map((s,i)=>{ const deals=db.deals.filter(d=>stageIdx(d.stage)===i); const val=deals.reduce((a,d)=>a+(+d.value||0),0); return`<div style="flex:1;min-width:100px;text-align:center;padding:14px;background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200)"><div style="font-size:11px;font-weight:700;color:var(--gray-500);text-transform:uppercase;margin-bottom:8px">${s}</div><div style="font-size:24px;font-weight:800">${deals.length}</div><div style="font-size:11px;color:var(--gray-500);margin-top:4px">${val>0?fmtMoney(val):'â€”'}</div></div>`; }).join('')}
        </div></div>
      </div>
    </div>`;
}

let coSearch='',coFilter='';
function renderCompanies() {
  let list=db.companies.filter(c=>{ const s=coSearch.toLowerCase(); return(!s||c.name.toLowerCase().includes(s)||(c.owner||'').toLowerCase().includes(s))&&(!coFilter||c.industry===coFilter); }).sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant'));
  const industries=[...new Set(db.companies.map(c=>c.industry).filter(Boolean))];
  document.getElementById('content').innerHTML=`<div class="card">
    <div class="card-header"><span class="card-title">å…± ${db.companies.length} å®¶å…¬å¸</span></div>
    <div class="card-body" style="padding:16px 20px 8px">
      <div class="toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœå°‹å…¬å¸ã€æ¥­å‹™å“¡..." value="${escHtml(coSearch)}" oninput="coSearch=this.value;renderCompanies()"></div>
        <select class="filter-select" onchange="coFilter=this.value;renderCompanies()"><option value="">å…¨éƒ¨ç”¢æ¥­</option>${industries.map(i=>`<option value="${i}" ${coFilter===i?'selected':''}>${i}</option>`).join('')}</select>
        <span style="color:var(--gray-500);font-size:13px">${list.length} ç­†</span>
        <button class="btn btn-primary btn-sm ml-auto" onclick="editingId=null;openModal('companyModal')">ï¼‹ æ–°å¢å…¬å¸</button>
      </div>
    </div>
    <div class="table-wrap">
      ${list.length===0?`<div class="empty-state"><div class="empty-icon">ğŸ¢</div><div class="empty-title">${coSearch||coFilter?'æ‰¾ä¸åˆ°ç¬¦åˆå…¬å¸':'å°šæœªæ–°å¢ä»»ä½•å…¬å¸'}</div></div>`:`
      <table><thead><tr><th>å…¬å¸åç¨±</th><th>ç”¢æ¥­</th><th>é›»è©±</th><th>Email</th><th>è² è²¬æ¥­å‹™</th><th>å•†æ©Ÿæ•¸</th><th>æ“ä½œ</th></tr></thead>
      <tbody>${list.map(c=>{ const deals=db.deals.filter(d=>d.companyId===c.id&&stageIdx(d.stage)!==5).length; const cts=db.contacts.filter(x=>x.companyId===c.id).length; return`<tr>
        <td><div style="font-weight:600">${escHtml(c.name)}</div><div style="font-size:12px;color:var(--gray-500)">${cts} ä½è¯çµ¡äºº</div></td>
        <td>${c.industry?`<span class="badge badge-blue">${escHtml(c.industry)}</span>`:'â€”'}</td>
        <td>${escHtml(c.phone)||'â€”'}</td>
        <td>${c.email?`<a href="mailto:${escHtml(c.email)}" style="color:var(--primary)">${escHtml(c.email)}</a>`:'â€”'}</td>
        <td>${escHtml(c.owner)||'â€”'}</td>
        <td><span class="badge ${deals>0?'badge-green':'badge-gray'}">${deals}</span></td>
        <td><div class="actions-cell"><button class="btn btn-secondary btn-sm" onclick="editingId='${c.id}';openModal('companyModal')">âœï¸ ç·¨è¼¯</button><button class="btn btn-secondary btn-sm" onclick="deleteCompany('${c.id}')">ğŸ—‘ï¸</button></div></td>
      </tr>`; }).join('')}</tbody></table>`}
    </div></div>`;
}

let ctSearch='',ctFilter='';
function renderContacts() {
  let list=db.contacts.filter(c=>{ const s=ctSearch.toLowerCase(); return(!s||c.name.toLowerCase().includes(s)||(c.title||'').toLowerCase().includes(s))&&(!ctFilter||c.companyId===ctFilter); });
  document.getElementById('content').innerHTML=`<div class="card">
    <div class="card-header"><span class="card-title">å…± ${db.contacts.length} ä½è¯çµ¡äºº</span></div>
    <div class="card-body" style="padding:16px 20px 8px">
      <div class="toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœå°‹å§“åã€è·ç¨±..." value="${escHtml(ctSearch)}" oninput="ctSearch=this.value;renderContacts()"></div>
        <select class="filter-select" onchange="ctFilter=this.value;renderContacts()"><option value="">å…¨éƒ¨å…¬å¸</option>${db.companies.map(c=>`<option value="${c.id}" ${ctFilter===c.id?'selected':''}>${escHtml(c.name)}</option>`).join('')}</select>
        <span style="color:var(--gray-500);font-size:13px">${list.length} ç­†</span>
        <button class="btn btn-primary btn-sm ml-auto" onclick="editingId=null;openModal('contactModal')">ï¼‹ æ–°å¢è¯çµ¡äºº</button>
      </div>
    </div>
    <div class="table-wrap">
      ${list.length===0?`<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">${ctSearch||ctFilter?'æ‰¾ä¸åˆ°ç¬¦åˆè¯çµ¡äºº':'å°šæœªæ–°å¢ä»»ä½•è¯çµ¡äºº'}</div></div>`:`
      <table><thead><tr><th>å§“å</th><th>è·ç¨±</th><th>æ‰€å±¬å…¬å¸</th><th>é›»è©±</th><th>Email</th><th>LINE ID</th><th>æ“ä½œ</th></tr></thead>
      <tbody>${list.map(c=>{ const co=db.companies.find(x=>x.id===c.companyId); return`<tr>
        <td><div style="font-weight:600">${escHtml(c.name)}</div><div style="font-size:12px;color:var(--gray-500)">${escHtml(c.dept)||''}</div></td>
        <td>${escHtml(c.title)||'â€”'}</td>
        <td>${co?`<span class="text-link">${escHtml(co.name)}</span>`:'â€”'}</td>
        <td>${escHtml(c.phone)||'â€”'}</td>
        <td>${c.email?`<a href="mailto:${escHtml(c.email)}" style="color:var(--primary)">${escHtml(c.email)}</a>`:'â€”'}</td>
        <td>${c.line?`<span style="color:#06c755;font-weight:500">ğŸ’¬ ${escHtml(c.line)}</span>`:'â€”'}</td>
        <td><div class="actions-cell"><button class="btn btn-secondary btn-sm" onclick="editingId='${c.id}';openModal('contactModal')">âœï¸ ç·¨è¼¯</button><button class="btn btn-secondary btn-sm" onclick="deleteContact('${c.id}')">ğŸ—‘ï¸</button></div></td>
      </tr>`; }).join('')}</tbody></table>`}
    </div></div>`;
}

// ==================== TARGETS ====================
function getTarget(owner, year, quarter) {
  var t = db.targets.filter(function(x){ return x.owner===owner && x.year===String(year) && x.quarter===String(quarter); })[0];
  return t ? (+t.amount||0) : 0;
}
function setTarget(owner, year, quarter, amount) {
  db.targets = db.targets.filter(function(x){ return !(x.owner===owner && x.year===String(year) && x.quarter===String(quarter)); });
  if (+amount > 0) db.targets.push({ owner:owner, year:String(year), quarter:String(quarter), amount:String(amount) });
  saveDB();
}
function promptTarget(owner) {
  var y = statsYear || String(new Date().getFullYear());
  var q = statsQuarter || '';
  var label = q ? y+' Q'+q : y+'å¹´ å…¨å¹´';
  var cur = getTarget(owner, y, q);
  var val = prompt('è¨­å®šã€Œ'+owner+'ã€çš„æ¥­ç¸¾ç›®æ¨™ï¼ˆ'+label+'ï¼‰\nç›®å‰ç›®æ¨™ï¼š'+(cur>0?fmtMoney(cur):'æœªè¨­å®š'), cur>0?cur:'');
  if (val===null) return;
  setTarget(owner, y, q, val.replace(/[^0-9.]/g,''));
  renderSalesStats();
  toast('ç›®æ¨™å·²è¨­å®š');
}

let statsYear = '';
let statsQuarter = '';

// å–å¾—å•†æ©Ÿçš„ã€Œæœ‰æ•ˆæˆäº¤æ—¥æœŸã€ï¼šå„ªå…ˆç”¨å¯¦éš›æˆäº¤æ—¥æœŸï¼Œå¦å‰‡ç”¨é è¨ˆæˆäº¤æ—¥æœŸ
function getCloseDate(deal) {
  return deal.actualCloseDate || deal.expectedCloseDate || '';
}

// å°‡ä»»æ„æ ¼å¼æ—¥æœŸï¼ˆISO å­—ä¸²ã€Date ç‰©ä»¶å­—ä¸²ï¼‰è½‰æˆ {year, month} æ•¸å­—
// ç›¸å®¹ Google Sheets å›å‚³çš„å®Œæ•´ Date å­—ä¸²ï¼Œä¾‹å¦‚ "Sat Feb 28 2026 00:00:00 GMT+0800"
function parseDateYM(dateStr) {
  if (!dateStr) return null;
  var s = String(dateStr).trim();
  // å„ªå…ˆç”¨ ISO æ ¼å¼ YYYY-MM-DD æˆ– YYYY/MM/DD
  var iso = s.match(/^(\d{4})[-\/](\d{1,2})/);
  if (iso) return { year: parseInt(iso[1]), month: parseInt(iso[2]) };
  // å›é€€ï¼šè®“ç€è¦½å™¨è§£æ
  var d = new Date(s);
  if (!isNaN(d.getTime())) return { year: d.getFullYear(), month: d.getMonth() + 1 };
  return null;
}

// æ ¹æ“šç›®å‰å¹´åº¦/å­£åº¦ç¯©é¸ã€Œå·²æˆäº¤ã€å•†æ©Ÿ
function filterWonByPeriod(wonDeals) {
  if (!statsYear && !statsQuarter) return wonDeals;
  return wonDeals.filter(function(d) {
    var ym = parseDateYM(getCloseDate(d));
    if (!ym) return false;
    if (statsYear && ym.year !== parseInt(statsYear)) return false;
    if (statsQuarter && Math.ceil(ym.month / 3) !== parseInt(statsQuarter)) return false;
    return true;
  });
}

function buildPeriodLabel() {
  if (statsYear && statsQuarter) return statsYear + ' Q' + statsQuarter;
  if (statsYear) return statsYear + ' å¹´';
  if (statsQuarter) return 'Q' + statsQuarter + 'ï¼ˆæ‰€æœ‰å¹´åº¦ï¼‰';
  return 'å…¨éƒ¨æ™‚é–“';
}

function buildYearBtns(availableYears) {
  var btns = '';
  var allYears = [''].concat(availableYears);
  for (var i = 0; i < allYears.length; i++) {
    var y = allYears[i];
    var active = (y === '' && statsYear === '') || (y !== '' && statsYear === y);
    var label = y === '' ? 'å…¨éƒ¨å¹´åº¦' : y + ' å¹´';
    var onclick = y === '' ? 'statsYear="";statsQuarter="";renderSalesStats()' : 'statsYear="' + y + '";renderSalesStats()';
    btns += '<button class="btn btn-sm ' + (active ? 'btn-primary' : 'btn-secondary') + '" onclick="' + onclick + '">' + label + '</button> ';
  }
  return btns;
}

function buildQBtns() {
  var btns = '';
  var quarters = [['', 'å…¨å¹´'], ['1', 'Q1'], ['2', 'Q2'], ['3', 'Q3'], ['4', 'Q4']];
  for (var i = 0; i < quarters.length; i++) {
    var q = quarters[i][0], label = quarters[i][1];
    var active = statsQuarter === q;
    btns += '<button class="btn btn-sm ' + (active ? 'btn-primary' : 'btn-secondary') + '" onclick="statsQuarter=\'' + q + '\';renderSalesStats()">' + label + '</button> ';
  }
  return btns;
}

function buildStatsRow(s) {
  var y = statsYear || String(new Date().getFullYear());
  var q = statsQuarter || '';
  var target = getTarget(s.owner, y, q);
  var pct = target > 0 ? Math.min(Math.round(s.wonValue/target*100), 100) : 0;
  var targetCell = target > 0
    ? ('<div style="font-size:12px;color:var(--gray-500)">' + fmtMoney(target) + '</div>'
      + '<div style="display:flex;align-items:center;gap:6px;margin-top:4px">'
      + '<div style="flex:1;background:var(--gray-100);border-radius:999px;height:6px;min-width:50px">'
      + '<div style="height:6px;border-radius:999px;background:' + (pct>=100?'var(--success)':'var(--primary)') + ';width:' + pct + '%"></div></div>'
      + '<span style="font-size:11px;font-weight:700;color:' + (pct>=100?'var(--success)':'var(--primary)') + '">' + pct + '%</span></div>')
    : '<span style="color:var(--gray-400);font-size:12px">æœªè¨­å®š</span>';

  var winBar = '<div style="display:flex;align-items:center;gap:8px"><div style="flex:1;background:var(--gray-100);border-radius:999px;height:8px;min-width:60px"><div style="height:8px;border-radius:999px;background:var(--success);width:' + s.winRate + '%"></div></div><span style="font-size:13px;font-weight:600;min-width:32px">' + s.winRate + '%</span></div>';
  var coCount = db.companies.filter(function(c){ return c.owner === s.owner; }).length;
  return '<tr>'
    + '<td><div style="font-weight:700;font-size:14px">' + escHtml(s.owner) + '</div>'
    + '<button class="btn btn-xs btn-secondary" style="margin-top:4px" onclick="promptTarget(\'' + escHtml(s.owner) + '\')">ğŸ¯ è¨­å®šç›®æ¨™</button></td>'
    + '<td>' + coCount + ' å®¶</td>'
    + '<td><span class="badge badge-blue">' + s.total + '</span></td>'
    + '<td>' + (s.active > 0 ? '<span class="badge badge-gray">' + s.active + '</span>' : 'â€”') + '</td>'
    + '<td>' + (s.won > 0 ? '<span class="badge badge-green">' + s.won + '</span>' : 'â€”') + '</td>'
    + '<td style="font-weight:600;color:var(--success)">' + (s.wonValue > 0 ? fmtMoney(s.wonValue) : 'â€”') + '</td>'
    + '<td>' + targetCell + '</td>'
    + '<td style="color:var(--primary)">' + (s.activeValue > 0 ? fmtMoney(s.activeValue) : 'â€”') + '</td>'
    + '<td>' + winBar + '</td>'
    + '<td>' + s.intCount + '</td>'
    + '</tr>';
}

function buildOwnerDistCard(s) {
  var stageCounts = STAGES.map(function(stage, si) {
    return { stage: stage, count: db.deals.filter(function(d){ return s.ownerCos.indexOf(d.companyId) >= 0 && stageIdx(d.stage) === si; }).length };
  });
  var boxes = '';
  for (var i = 0; i < stageCounts.length; i++) {
    var sc = stageCounts[i];
    var color = sc.stage === 'æˆäº¤' ? 'var(--success)' : sc.stage === 'å¤±å–®' ? 'var(--danger)' : 'var(--primary)';
    boxes += '<div style="flex:1;min-width:80px;text-align:center;padding:12px;background:var(--gray-50);border-radius:8px;border:1px solid var(--gray-200)">'
      + '<div style="font-size:10px;font-weight:700;color:var(--gray-500);margin-bottom:6px">' + sc.stage + '</div>'
      + '<div style="font-size:22px;font-weight:800;color:' + color + '">' + sc.count + '</div>'
      + '</div>';
  }
  return '<div class="card" style="margin-top:16px">'
    + '<div class="card-header"><span class="card-title">ğŸ“‹ ' + escHtml(s.owner) + ' çš„å•†æ©Ÿåˆ†å¸ƒ</span><span class="badge badge-blue">' + s.total + ' ä»¶å•†æ©Ÿ</span></div>'
    + '<div class="card-body"><div style="display:flex;gap:12px;flex-wrap:wrap">' + boxes + '</div></div>'
    + '</div>';
}

function renderSalesStats() {
  var el = document.getElementById('content');
  var owners = [];
  var seen = {};
  db.companies.forEach(function(c){ if(c.owner && !seen[c.owner]){ seen[c.owner]=1; owners.push(c.owner); } });

  var allWon = db.deals.filter(function(d){ return stageIdx(d.stage) === 4; });
  var allWonValue = allWon.reduce(function(a,d){ return a + (+d.value||0); }, 0);
  var wonNoOwner = allWon.filter(function(d){
    var co = db.companies.filter(function(c){ return c.id === d.companyId; })[0];
    return !co || !co.owner;
  });

  // â”€â”€ ç„¡æ¥­å‹™å“¡æ™‚é¡¯ç¤ºè¨ºæ–· â”€â”€
  if (owners.length === 0) {
    var rows = '';
    for (var i = 0; i < allWon.length; i++) {
      var d = allWon[i];
      var co = db.companies.filter(function(c){ return c.id === d.companyId; })[0];
      var coName = co ? escHtml(co.name) : '<span style="color:var(--danger)">ï¼ˆæ‰¾ä¸åˆ°å…¬å¸ï¼‰</span>';
      var ownerCell = (co && co.owner) ? escHtml(co.owner) : '<span style="color:var(--warning)">æœªè¨­å®š</span>';
      var valCell = (+d.value > 0) ? fmtMoney(+d.value) : '<span style="color:var(--gray-400)">æœªå¡«é‡‘é¡</span>';
      var dateCell = d.actualCloseDate ? fmt(d.actualCloseDate) : (d.expectedCloseDate ? fmt(d.expectedCloseDate) + ' (é è¨ˆ)' : '<span style="color:var(--gray-400)">æœªå¡«</span>');
      rows += '<tr><td style="font-weight:600">' + escHtml(d.title) + '</td><td>' + coName + '</td><td>' + ownerCell + '</td><td style="color:var(--success);font-weight:600">' + valCell + '</td><td>' + dateCell + '</td></tr>';
    }
    var tableHtml = allWon.length === 0
      ? '<div style="text-align:center;padding:24px;color:var(--gray-400)">ç›®å‰æ²’æœ‰ä»»ä½•éšæ®µç‚ºã€Œæˆäº¤ã€çš„å•†æ©Ÿ</div>'
      : '<div class="table-wrap"><table><thead><tr><th>å•†æ©Ÿåç¨±</th><th>å…¬å¸</th><th>è² è²¬æ¥­å‹™</th><th>é‡‘é¡</th><th>æˆäº¤æ—¥æœŸ</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
    el.innerHTML = '<div class="card" style="margin-bottom:16px;border-left:4px solid var(--warning)"><div class="card-body" style="padding:16px 20px"><div style="font-size:13px;font-weight:700;color:var(--warning);margin-bottom:8px">âš ï¸ å°šæœªè¨­å®šè² è²¬æ¥­å‹™</div><div style="font-size:13px;color:var(--gray-600)">æ¥­ç¸¾çµ±è¨ˆä¾ã€Œå…¬å¸å®¢æˆ¶ã€çš„ã€Œè² è²¬æ¥­å‹™ã€æ¬„ä½åˆ†é¡ï¼Œè«‹è‡³å…¬å¸è³‡æ–™å¡«å¯«è² è²¬æ¥­å‹™å§“åã€‚</div></div></div>'
      + '<div class="card"><div class="card-header"><span class="card-title">ğŸ“‹ å…¨éƒ¨æˆäº¤å•†æ©Ÿï¼ˆ' + allWon.length + ' ç­†ï¼‰</span><span style="font-size:13px;font-weight:700;color:var(--success)">' + (allWonValue > 0 ? fmtMoney(allWonValue) : 'å°šç„¡æˆäº¤é‡‘é¡') + '</span></div><div class="card-body">' + tableHtml + '</div></div>';
    return;
  }

  // â”€â”€ å¹´ä»½é¸é … â”€â”€
  var yearSet = {};
  allWon.forEach(function(d){ var ym = parseDateYM(getCloseDate(d)); if(ym) yearSet[ym.year]=1; });
  var availableYears = Object.keys(yearSet).sort().reverse();

  // â”€â”€ çµ±è¨ˆè¨ˆç®— â”€â”€
  var stats = owners.map(function(owner) {
    var ownerCos = db.companies.filter(function(c){ return c.owner === owner; }).map(function(c){ return c.id; });
    var ownerDeals = db.deals.filter(function(d){ return ownerCos.indexOf(d.companyId) >= 0; });
    var allWonDeals = ownerDeals.filter(function(d){ return stageIdx(d.stage) === 4; });
    var wonDeals = filterWonByPeriod(allWonDeals);
    var activeDeals = ownerDeals.filter(function(d){ return stageIdx(d.stage) !== 4 && stageIdx(d.stage) !== 5; });
    var lostDeals = ownerDeals.filter(function(d){ return stageIdx(d.stage) === 5; });
    var wonValue = wonDeals.reduce(function(a,d){ return a + (+d.value||0); }, 0);
    var activeValue = activeDeals.reduce(function(a,d){ return a + (+d.value||0); }, 0);
    var winRate = ownerDeals.length > 0 ? Math.round(allWonDeals.length / ownerDeals.length * 100) : 0;
    var intCount = db.interactions.filter(function(i){ return ownerCos.indexOf(i.companyId) >= 0; }).length;
    return { owner:owner, total:ownerDeals.length, won:wonDeals.length, lost:lostDeals.length, active:activeDeals.length, wonValue:wonValue, activeValue:activeValue, winRate:winRate, intCount:intCount, ownerCos:ownerCos };
  });
  stats.sort(function(a,b){ return b.wonValue - a.wonValue; });

  var totalWon = stats.reduce(function(a,s){ return a + s.wonValue; }, 0);
  var totalPipeline = stats.reduce(function(a,s){ return a + s.activeValue; }, 0);
  var periodLabel = buildPeriodLabel();
  var y = statsYear || String(new Date().getFullYear());
  var q = statsQuarter || '';
  var totalTarget = owners.reduce(function(sum, owner){ return sum + getTarget(owner, y, q); }, 0);
  var combined = totalWon + totalPipeline;
  var wonBarPct  = combined > 0 ? Math.round(totalWon      / combined * 100) : 0;
  var pipeBarPct = combined > 0 ? Math.round(totalPipeline / combined * 100) : 0;
  var targetAchievePct = totalTarget > 0 ? Math.min(Math.round(totalWon / totalTarget * 100), 999) : 0;
  var targetBarPct     = totalTarget > 0 ? Math.min(Math.round(totalWon / totalTarget * 100), 100) : 0;

  // â”€â”€ çµ„è£ HTML â”€â”€
  var warn = wonNoOwner.length > 0 ? '<div class="alert-warning" style="margin-bottom:12px">âš ï¸ æœ‰ ' + wonNoOwner.length + ' ç­†æˆäº¤å•†æ©Ÿæ‰€å±¬å…¬å¸æœªè¨­å®šã€Œè² è²¬æ¥­å‹™ã€ï¼Œæœªè¨ˆå…¥ä¸‹æ–¹çµ±è¨ˆã€‚</div>' : '';

  var filterCard = '<div class="card" style="margin-bottom:16px"><div class="card-body" style="padding:14px 20px">'
    + '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-size:13px;font-weight:600;color:var(--gray-600)">ğŸ“… å¹´åº¦ï¼š</span>' + buildYearBtns(availableYears) + '</div>'
    + '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px"><span style="font-size:13px;font-weight:600;color:var(--gray-600)">ğŸ“† å­£åº¦ï¼š</span>' + buildQBtns()
    + '<span style="font-size:12px;color:var(--gray-400);margin-left:auto">ç›®å‰ï¼š<strong style="color:var(--primary)">' + periodLabel + '</strong></span></div>'
    + '<div style="margin-top:8px;font-size:12px;color:var(--gray-400)">ğŸ’¡ å„ªå…ˆä½¿ç”¨ã€Œå¯¦éš›æˆäº¤æ—¥æœŸã€çµ±è¨ˆï¼›æœªå¡«è€…ä»¥ã€Œé è¨ˆæˆäº¤æ—¥æœŸã€ä»£æ›¿</div>'
    + '</div></div>';

  // â”€â”€ é”æˆ vs é ä¼° æ¦‚è¦½å¡ â”€â”€
  var achieveColor = targetAchievePct >= 100 ? 'var(--success)' : targetAchievePct >= 60 ? 'var(--primary)' : 'var(--warning)';
  var overviewCard = '<div class="card" style="margin-bottom:16px">'
    + '<div class="card-header"><span class="card-title">ğŸ“Š æ¥­ç¸¾æ¦‚è¦½</span><span style="font-size:12px;color:var(--gray-400)">' + periodLabel + '</span></div>'
    + '<div class="card-body">'
    + '<div style="display:flex;gap:24px;flex-wrap:wrap;margin-bottom:18px">'
    // é”æˆæ¥­ç¸¾
    + '<div style="flex:1;min-width:140px">'
    + '<div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;margin-bottom:4px">âœ… é”æˆæ¥­ç¸¾</div>'
    + '<div style="font-size:22px;font-weight:800;color:var(--success)">' + (totalWon > 0 ? fmtMoney(totalWon) : 'NT$ 0') + '</div>'
    + '</div>'
    // é ä¼°æ¥­ç¸¾
    + '<div style="flex:1;min-width:140px">'
    + '<div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;margin-bottom:4px">ğŸ“ˆ é ä¼°æ¥­ç¸¾ï¼ˆç®¡é“ï¼‰</div>'
    + '<div style="font-size:22px;font-weight:800;color:var(--primary)">' + (totalPipeline > 0 ? fmtMoney(totalPipeline) : 'NT$ 0') + '</div>'
    + '</div>'
    // ç›®æ¨™é”æˆç‡
    + (totalTarget > 0
      ? '<div style="flex:1;min-width:140px">'
        + '<div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;margin-bottom:4px">ğŸ¯ ç›®æ¨™é”æˆç‡</div>'
        + '<div style="font-size:22px;font-weight:800;color:' + achieveColor + '">' + targetAchievePct + '%</div>'
        + '<div style="font-size:12px;color:var(--gray-400)">ç›®æ¨™ ' + fmtMoney(totalTarget) + '</div>'
        + '</div>'
      : '')
    + '</div>'
    // å †ç–Šé€²åº¦æ¢
    + '<div style="margin-bottom:6px">'
    + '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--gray-500);margin-bottom:4px">'
    + '<span>é”æˆ ' + wonBarPct + '%ã€€é ä¼° ' + pipeBarPct + '%</span>'
    + '<span style="color:var(--gray-400)">åˆè¨ˆæ½›åŠ› ' + (combined > 0 ? fmtMoney(combined) : 'â€”') + '</span>'
    + '</div>'
    + '<div style="height:12px;border-radius:999px;background:var(--gray-100);overflow:hidden;display:flex">'
    + (wonBarPct > 0  ? '<div style="height:100%;width:' + wonBarPct  + '%;background:var(--success);transition:width .5s"></div>' : '')
    + (pipeBarPct > 0 ? '<div style="height:100%;width:' + pipeBarPct + '%;background:var(--primary);opacity:.5;transition:width .5s"></div>' : '')
    + '</div>'
    + '<div style="display:flex;gap:16px;margin-top:6px;font-size:11.5px;color:var(--gray-500)">'
    + '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:var(--success);margin-right:4px;vertical-align:middle"></span>é”æˆæ¥­ç¸¾</span>'
    + '<span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:var(--primary);opacity:.5;margin-right:4px;vertical-align:middle"></span>é ä¼°ç®¡é“</span>'
    + '</div></div>'
    // ç›®æ¨™é”æˆé€²åº¦æ¢ï¼ˆå¦‚æœ‰è¨­å®šç›®æ¨™ï¼‰
    + (totalTarget > 0
      ? '<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--gray-100)">'
        + '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--gray-500);margin-bottom:4px">'
        + '<span>ğŸ¯ ç›®æ¨™é”æˆé€²åº¦</span>'
        + '<span>' + fmtMoney(totalWon) + ' / ' + fmtMoney(totalTarget) + '</span>'
        + '</div>'
        + '<div style="height:12px;border-radius:999px;background:var(--gray-100);overflow:hidden">'
        + '<div style="height:100%;width:' + targetBarPct + '%;background:' + achieveColor + ';transition:width .5s"></div>'
        + '</div></div>'
      : '<div style="margin-top:10px;font-size:12px;color:var(--gray-400)">ğŸ’¡ åœ¨ä¸‹æ–¹æ¥­ç¸¾æ˜ç´°ä¸­é»ã€ŒğŸ¯ è¨­å®šç›®æ¨™ã€ï¼Œå³å¯é¡¯ç¤ºç›®æ¨™é”æˆé€²åº¦æ¢ã€‚</div>')
    + '</div></div>';

  var activeTotal = db.deals.filter(function(d){ return stageIdx(d.stage) !== 4 && stageIdx(d.stage) !== 5; }).length;
  var wonTotal = db.deals.filter(function(d){ return stageIdx(d.stage) === 4; }).length;
  var statsGrid = '<div class="stats-grid" style="margin-bottom:20px">'
    + '<div class="stat-card"><div class="stat-icon" style="background:#eff6ff">ğŸ‘¥</div><div class="stat-label">æ¥­å‹™å“¡äººæ•¸</div><div class="stat-value">' + owners.length + '</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#f0fdf4">âœ…</div><div class="stat-label">é”æˆæ¥­ç¸¾ï¼ˆ' + periodLabel + 'ï¼‰</div><div class="stat-value" style="font-size:18px;color:var(--success)">' + (totalWon > 0 ? fmtMoney(totalWon) : 'NT$ 0') + '</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#eff6ff">ğŸ“ˆ</div><div class="stat-label">é ä¼°æ¥­ç¸¾ï¼ˆç®¡é“ï¼‰</div><div class="stat-value" style="font-size:18px;color:var(--primary)">' + (totalPipeline > 0 ? fmtMoney(totalPipeline) : 'NT$ 0') + '</div><div class="stat-sub">é€²è¡Œä¸­ ' + activeTotal + ' ä»¶</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#fef2f2">ğŸ†</div><div class="stat-label">æ•´é«”æˆäº¤ç‡</div><div class="stat-value">' + (db.deals.length > 0 ? Math.round(wonTotal / db.deals.length * 100) : 0) + '%</div></div>'
    + '</div>';

  var tableRows = '';
  for (var i = 0; i < stats.length; i++) { tableRows += buildStatsRow(stats[i]); }
  var mainTable = '<div class="card">'
    + '<div class="card-header"><span class="card-title">ğŸ“Š æ¥­å‹™å“¡æ¥­ç¸¾æ˜ç´°</span><span style="font-size:12px;color:var(--gray-400)">' + periodLabel + '</span></div>'
    + '<div class="table-wrap"><table>'
    + '<thead><tr><th>æ¥­å‹™å“¡</th><th>è² è²¬å…¬å¸</th><th>å•†æ©Ÿç¸½æ•¸</th><th>é€²è¡Œä¸­</th><th>æœŸé–“æˆäº¤</th><th>æˆäº¤é‡‘é¡</th><th>ç›®æ¨™é”æˆ</th><th>é ä¼°ç®¡é“</th><th>æˆäº¤ç‡</th><th>äº’å‹•è¨˜éŒ„</th></tr></thead>'
    + '<tbody>' + tableRows + '</tbody></table></div></div>';

  var distCards = '';
  for (var j = 0; j < stats.length; j++) { distCards += buildOwnerDistCard(stats[j]); }

  el.innerHTML = warn + filterCard + overviewCard + statsGrid + mainTable + distCards;
}

let plFilter='', plTypeFilter='';
let showArchived = false;
const DEAL_TYPE_COLORS = { 'æ‹›å‹Ÿç¶“éŠ·å•†':'#3b82f6', 'èªè­‰æŠ€è¡“å£«':'#16a34a', 'ä¾¿åˆ©çš„å°ˆæ¡ˆ':'#f59e0b' };
function dealTypeBadge(type) {
  if (!type) return '';
  const c = DEAL_TYPE_COLORS[type] || 'var(--gray-400)';
  return '<span style="display:inline-block;font-size:10.5px;font-weight:600;padding:1px 7px;border-radius:10px;background:'+c+'22;color:'+c+';border:1px solid '+c+'44;margin-bottom:4px">'+escHtml(type)+'</span>';
}
function renderPipeline() {
  const totalActive=db.deals.filter(d=>stageIdx(d.stage)!==4&&stageIdx(d.stage)!==5);
  document.getElementById('content').innerHTML=`
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="font-size:13.5px;color:var(--gray-600)">é€²è¡Œä¸­ï¼š<strong>${totalActive.length} ä»¶</strong>ï¼Œé ä¼°ï¼š<strong>${fmtMoney(totalActive.reduce((a,d)=>a+(+d.value||0),0))}</strong></div>
      <select class="filter-select" style="margin-left:auto" onchange="plTypeFilter=this.value;renderPipeline()">
        <option value="">å…¨éƒ¨é¡å‹</option>
        <option value="æ‹›å‹Ÿç¶“éŠ·å•†" ${plTypeFilter==='æ‹›å‹Ÿç¶“éŠ·å•†'?'selected':''}>ğŸ¤ æ‹›å‹Ÿç¶“éŠ·å•†</option>
        <option value="èªè­‰æŠ€è¡“å£«" ${plTypeFilter==='èªè­‰æŠ€è¡“å£«'?'selected':''}>ğŸ“ èªè­‰æŠ€è¡“å£«</option>
        <option value="ä¾¿åˆ©çš„å°ˆæ¡ˆ" ${plTypeFilter==='ä¾¿åˆ©çš„å°ˆæ¡ˆ'?'selected':''}>ğŸ”§ ä¾¿åˆ©çš„å°ˆæ¡ˆ</option>
      </select>
      <select class="filter-select" onchange="plFilter=this.value;renderPipeline()">
        <option value="">å…¨éƒ¨æ¥­å‹™å“¡</option>
        ${[...new Set(db.companies.map(c=>c.owner).filter(Boolean))].map(o=>`<option value="${o}" ${plFilter===o?'selected':''}>${escHtml(o)}</option>`).join('')}
      </select>
      <button class="btn btn-secondary btn-sm" onclick="showArchived=!showArchived;renderPipeline()">${showArchived?'éš±è—å°å­˜':'é¡¯ç¤ºå°å­˜'}</button>
      <button class="btn btn-primary btn-sm" onclick="editingId=null;openModal('dealModal')">ï¼‹ æ–°å¢å•†æ©Ÿ</button>
    </div>
    <div class="pipeline-board">
      ${STAGES.map((stage,idx)=>{
        let deals=db.deals.filter(d=>stageIdx(d.stage)===idx && d.archived!=='true');
        if(plFilter) deals=deals.filter(d=>{ const co=db.companies.find(c=>c.id===d.companyId); return co&&co.owner===plFilter; });
        if(plTypeFilter) deals=deals.filter(d=>d.dealType===plTypeFilter);
        const stageVal=deals.reduce((a,d)=>a+(+d.value||0),0);
        return`<div class="pipeline-col">
          <div class="pipeline-col-header stage-${idx}"><span class="pipeline-col-title" style="color:#fff">${stage}</span><span class="pipeline-col-count">${deals.length}</span></div>
          <div style="padding:3px 8px;background:${['#6366f122','#0ea5e922','#f59e0b22','#f9731622','#22c55e22','#ef444422'][idx]}"><span style="font-size:11px;color:var(--gray-600)">${stageVal>0?fmtMoney(stageVal):' '}</span></div>
          <div class="pipeline-col-body" data-stage="${idx}" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event,${idx})">
            ${deals.length===0?'<div style="text-align:center;padding:20px;color:var(--gray-400);font-size:12px">ç„¡å•†æ©Ÿ<br><span style=\'font-size:11px;opacity:.7\'>æ‹–æ›³å¡ç‰‡è‡³æ­¤</span></div>':
            deals.map(d=>{ const co=db.companies.find(c=>c.id===d.companyId); const diff=d.expectedCloseDate?daysDiff(d.expectedCloseDate):null; const od=diff!==null&&diff<0; return`<div class="pipeline-card" draggable="true" data-deal-id="${d.id}" ondragstart="handleDragStart(event,'${d.id}')" ondragend="handleDragEnd(event)" onclick="if(!window._isDragging){editingId='${d.id}';openModal('dealModal')}">
              ${dealTypeBadge(d.dealType)}
              <div class="pipeline-card-title">${escHtml(d.title)}</div>
              <div class="pipeline-card-company">ğŸ¢ ${co?escHtml(co.name):'â€”'}</div>
              ${d.value?`<div class="pipeline-card-value">${fmtMoney(d.value)}</div>`:''}
              ${d.expectedCloseDate?`<div class="pipeline-card-date" style="${od?'color:var(--danger);font-weight:600':''}">ğŸ“… ${fmt(d.expectedCloseDate)}${od?` (é€¾æœŸ${Math.abs(diff)}å¤©)`:''}</div>`:''}
              <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">${stageIdx(d.stage)===4 ? '<button class="btn btn-xs btn-secondary" onclick="event.stopPropagation();convertDealToProject(\''+d.id+'\')" title="å»ºç«‹å°æ‡‰å°ˆæ¡ˆ">ğŸš§ è½‰å°ˆæ¡ˆ</button>' : ''}<button class="btn btn-xs" style="color:var(--danger);border:1px solid var(--gray-200);background:#fff" onclick="event.stopPropagation();deleteDeal('${d.id}')">åˆªé™¤</button></div>
            </div>`; }).join('')}
          </div></div>`;
      }).join('')}
      ${showArchived ? buildArchivedSection() : ''}
    </div>`;
}

let intSearch='',intFilter='';
function renderInteractions() {
  let list=[...db.interactions].sort((a,b)=>b.date.localeCompare(a.date));
  if(intSearch){const s=intSearch.toLowerCase();list=list.filter(i=>i.subject.toLowerCase().includes(s)||(i.notes||'').toLowerCase().includes(s));}
  if(intFilter) list=list.filter(i=>i.type===intFilter);
  document.getElementById('content').innerHTML=`<div class="card">
    <div class="card-header"><span class="card-title">å…± ${db.interactions.length} ç­†äº’å‹•è¨˜éŒ„</span></div>
    <div class="card-body" style="padding:16px 20px 8px">
      <div class="toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœå°‹ä¸»æ—¨ã€å…§å®¹..." value="${escHtml(intSearch)}" oninput="intSearch=this.value;renderInteractions()"></div>
        <select class="filter-select" onchange="intFilter=this.value;renderInteractions()"><option value="">å…¨éƒ¨é¡å‹</option><option value="call">ğŸ“ é›»è©±</option><option value="email">ğŸ“§ Email</option><option value="meeting">ğŸ¤ æœƒè­°</option><option value="visit">ğŸš— æ‹œè¨ª</option><option value="other">ğŸ’¬ å…¶ä»–</option></select>
        <span style="color:var(--gray-500);font-size:13px">${list.length} ç­†</span>
        <button class="btn btn-primary btn-sm ml-auto" onclick="editingId=null;openModal('intModal')">ï¼‹ æ–°å¢è¨˜éŒ„</button>
      </div>
    </div>
    <div class="card-body" style="padding-top:0">
      ${list.length===0?`<div class="empty-state"><div class="empty-icon">ğŸ’¬</div><div class="empty-title">${intSearch||intFilter?'æ‰¾ä¸åˆ°ç¬¦åˆè¨˜éŒ„':'å°šç„¡äº’å‹•è¨˜éŒ„'}</div></div>`:`
      <div class="timeline">${list.map(i=>{ const co=db.companies.find(c=>c.id===i.companyId); const ct=db.contacts.find(c=>c.id===i.contactId); return`<div class="timeline-item">
        <div class="timeline-icon" style="background:${INT_COLORS[i.type]||'#f1f5f9'}">${INT_ICONS[i.type]||'ğŸ’¬'}</div>
        <div class="timeline-content">
          <div class="timeline-header">
            <span class="timeline-subject">${escHtml(i.subject)}</span>
            ${co?`<span class="badge badge-blue">${escHtml(co.name)}</span>`:''}
            ${ct?`<span class="badge badge-gray">${escHtml(ct.name)}</span>`:''}
            ${i.createdBy?`<span class="badge" style="background:#fef3c7;color:#92400e">${escHtml(i.createdBy)}</span>`:''}
            <span class="timeline-date">${fmt(i.date)}</span>
          </div>
          ${i.notes?`<div class="timeline-notes">${escHtml(i.notes)}</div>`:''}
        </div>
        <div style="display:flex;gap:6px;align-self:flex-start;margin-top:4px">
          <button class="btn btn-secondary btn-sm" onclick="editingId='${i.id}';openModal('intModal')">âœï¸</button>
          <button class="btn btn-secondary btn-sm" onclick="deleteInteraction('${i.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`; }).join('')}</div>`}
    </div></div>`;
}

let tkSearch='',tkFilter='todo',tkPri='';
function renderTasks() {
  let list=[...db.tasks];
  if(tkSearch){const s=tkSearch.toLowerCase();list=list.filter(t=>t.title.toLowerCase().includes(s));}
  if(tkFilter==='todo') list=list.filter(t=>t.status==='todo');
  else if(tkFilter==='done') list=list.filter(t=>t.status==='done');
  if(tkPri) list=list.filter(t=>t.priority===tkPri);
  list.sort((a,b)=>{ if(a.status!==b.status)return a.status==='todo'?-1:1; const p={high:0,med:1,low:2}; if(a.priority!==b.priority)return(p[a.priority]||1)-(p[b.priority]||1); if(a.dueDate&&b.dueDate)return a.dueDate.localeCompare(b.dueDate); if(a.dueDate)return -1; if(b.dueDate)return 1; return 0; });
  const pending=db.tasks.filter(t=>t.status==='todo').length;
  const done=db.tasks.filter(t=>t.status==='done').length;
  document.getElementById('content').innerHTML=`<div class="card">
    <div class="card-header"><span class="card-title">ä»»å‹™ç®¡ç†</span><div style="display:flex;gap:8px;font-size:12.5px"><span style="color:var(--gray-500)">å¾…è¾¦ <strong>${pending}</strong></span><span style="color:var(--gray-400)">Â·</span><span style="color:var(--gray-500)">å·²å®Œæˆ <strong>${done}</strong></span></div></div>
    <div class="card-body" style="padding:16px 20px 8px">
      <div class="toolbar">
        <div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœå°‹ä»»å‹™..." value="${escHtml(tkSearch)}" oninput="tkSearch=this.value;renderTasks()"></div>
        <select class="filter-select" onchange="tkFilter=this.value;renderTasks()"><option value="">å…¨éƒ¨</option><option value="todo" ${tkFilter==='todo'?'selected':''}>å¾…è¾¦</option><option value="done" ${tkFilter==='done'?'selected':''}>å·²å®Œæˆ</option></select>
        <select class="filter-select" onchange="tkPri=this.value;renderTasks()"><option value="">å…¨éƒ¨å„ªå…ˆç´š</option><option value="high">ğŸ”´ é«˜</option><option value="med">ğŸŸ¡ ä¸­</option><option value="low">ğŸŸ¢ ä½</option></select>
        <span style="color:var(--gray-500);font-size:13px">${list.length} ç­†</span>
        ${done>0?`<button class="btn btn-secondary btn-sm" onclick="clearDoneTasks()" style="color:var(--danger);border-color:var(--danger)">ğŸ—‘ï¸ æ¸…é™¤å·²å®Œæˆ (${done})</button>`:''}
        <button class="btn btn-primary btn-sm ml-auto" onclick="editingId=null;openModal('taskModal')">ï¼‹ æ–°å¢ä»»å‹™</button>
      </div>
    </div>
    <div class="card-body" style="padding-top:4px">
      ${list.length===0?`<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-title">${tkSearch||tkPri?'æ‰¾ä¸åˆ°ç¬¦åˆä»»å‹™':tkFilter==='done'?'å°šç„¡å·²å®Œæˆä»»å‹™':'æ²’æœ‰å¾…è¾¦ä»»å‹™'}</div></div>`:`
      <div>${list.map(t=>{ const d=t.dueDate?daysDiff(t.dueDate):null; const co=db.companies.find(c=>c.id===t.companyId); const done=t.status==='done'; const overdue=!done&&d!==null&&d<0; const dueTxt=d===null?'':done?fmt(t.dueDate):overdue?`<span class="task-overdue">é€¾æœŸ ${Math.abs(d)} å¤©ï¼ˆ${fmt(t.dueDate)}ï¼‰</span>`:d===0?`<span style="color:var(--warning);font-weight:600">ä»Šå¤©åˆ°æœŸ</span>`:fmt(t.dueDate)+`ï¼ˆ${d}å¤©å¾Œï¼‰`; const priMap={high:'ğŸ”´ é«˜',med:'ğŸŸ¡ ä¸­',low:'ğŸŸ¢ ä½'}; return`<div class="task-item">
        <div class="task-check ${done?'done':''}" onclick="toggleTask('${t.id}')">${done?'âœ“':''}</div>
        <div class="task-content">
          <div class="task-title ${done?'done-text':''}">${escHtml(t.title)}${done?'<span style="font-size:11px;color:var(--gray-400);font-weight:400;margin-left:8px">3 ç§’å¾Œè‡ªå‹•æ¸…é™¤ãƒ»é»å‹¾å¯å–æ¶ˆ</span>':''}</div>
          <div class="task-meta">
            <span class="${t.priority==='high'?'pri-high':t.priority==='low'?'pri-low':'pri-med'}">${priMap[t.priority]||'ä¸­'}</span>
            ${t.dueDate?`<span>ğŸ“… ${dueTxt}</span>`:''}
            ${co?`<span>ğŸ¢ ${escHtml(co.name)}</span>`:''}
          </div>
          ${t.notes?`<div style="font-size:12px;color:var(--gray-500);margin-top:4px">${escHtml(t.notes)}</div>`:''}
        </div>
        <div style="display:flex;gap:6px;align-self:flex-start">
          <button class="btn btn-secondary btn-sm" onclick="editingId='${t.id}';openModal('taskModal')">âœï¸</button>
          <button class="btn btn-secondary btn-sm" onclick="deleteTask('${t.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`; }).join('')}</div>`}
    </div></div>`;
}

// ==================== TOAST ====================
function toast(msg,type='success') {
  const el=document.createElement('div');
  el.className=`toast-item ${type}`;
  el.innerHTML=`${type==='success'?'âœ…':type==='error'?'âŒ':'â„¹ï¸'} ${escHtml(msg)}`;
  document.getElementById('toast').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ==================== MASS EMAIL ====================
let meStep = 1, meMode = 'contacts', meSelected = new Set();
let meSubject = '', meBody = '', meSenderName = '';
let meSearchTerm = '';
let mePendingRecipients = []; // å…¨åŸŸå„²å­˜ï¼Œé¿å… onclick å‚³ JSON å•é¡Œ

function getAllMeItems() {
  if (meMode === 'contacts') {
    return db.contacts.filter(c => c.email).map(c => {
      const co = db.companies.find(x => x.id === c.companyId);
      return { email: c.email, name: c.name, company: co ? co.name : '', title: c.title||'', owner: co ? co.owner||'' : '' };
    });
  }
  return db.companies.filter(c => c.email).map(c => {
    const pc = db.contacts.find(x => x.companyId === c.id);
    return { email: c.email, name: pc ? pc.name : c.name, company: c.name, title: pc ? pc.title||'' : '', owner: c.owner||'' };
  });
}

function mergeFields(text, r) {
  return (text||'').replace(/\{\{å§“å\}\}/g, r.name||'').replace(/\{\{å…¬å¸\}\}/g, r.company||'').replace(/\{\{è·ç¨±\}\}/g, r.title||'').replace(/\{\{æ¥­å‹™å“¡\}\}/g, r.owner||'');
}

function meToggle(email, checked) {
  if (checked) meSelected.add(email); else meSelected.delete(email);
  const b = document.getElementById('me-count-badge');
  if (b) b.textContent = 'å·²é¸ ' + meSelected.size + ' ä½æ”¶ä»¶äºº';
}

function meInsertField(id, field) {
  const el = document.getElementById(id);
  if (!el) return;
  const s = el.selectionStart, e2 = el.selectionEnd;
  el.value = el.value.slice(0,s) + field + el.value.slice(e2);
  el.focus(); el.setSelectionRange(s+field.length, s+field.length);
}

function meSaveCompose() {
  meSubject = document.getElementById('me-subject') ? document.getElementById('me-subject').value : meSubject;
  meBody = document.getElementById('me-body') ? document.getElementById('me-body').value : meBody;
  meSenderName = document.getElementById('me-sender') ? document.getElementById('me-sender').value : meSenderName;
}

function renderMassEmail() {
  const stepNames = ['é¸æ“‡æ”¶ä»¶äºº','ç·¨å¯«éƒµä»¶','é è¦½ç™¼é€'];
  const stepBar = stepNames.map((s,i) => {
    const n=i+1, done=meStep>n, active=meStep===n;
    const bg = active ? 'var(--primary)' : done ? 'var(--success)' : 'var(--gray-100)';
    const color = (active||done) ? '#fff' : 'var(--gray-400)';
    const radius = i===0 ? '8px 0 0 8px' : i===stepNames.length-1 ? '0 8px 8px 0' : '0';
    return '<div style="flex:1;padding:10px 8px;text-align:center;font-size:12.5px;font-weight:600;background:'+bg+';color:'+color+';border-radius:'+radius+'">'+(done?'âœ“ ':'')+n+'. '+s+'</div>';
  }).join('');

  let stepContent = '';
  if (meStep===1) stepContent = renderMeStep1();
  else if (meStep===2) stepContent = renderMeStep2();
  else stepContent = renderMeStep3();

  document.getElementById('content').innerHTML =
    '<div style="display:flex;gap:0;margin-bottom:20px;border-radius:8px;overflow:hidden;border:1px solid var(--gray-200)">'+stepBar+'</div>' +
    stepContent;

  if (meStep === 2) {
    const subEl = document.getElementById('me-subject');
    const bodyEl = document.getElementById('me-body');
    const senderEl = document.getElementById('me-sender');
    if (subEl) subEl.value = meSubject;
    if (bodyEl) bodyEl.value = meBody;
    if (senderEl) senderEl.value = meSenderName;
  }
}

function renderMeStep1() {
  let items = getAllMeItems();
  if (meSearchTerm) {
    const s = meSearchTerm.toLowerCase();
    items = items.filter(i => i.name.toLowerCase().includes(s) || i.company.toLowerCase().includes(s) || i.email.toLowerCase().includes(s));
  }
  const allChecked = items.length > 0 && items.every(i => meSelected.has(i.email));
  const emails = JSON.stringify(items.map(i => i.email));

  let listHtml = '';
  if (items.length === 0) {
    listHtml = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">æ²’æœ‰å« Email çš„' + (meMode==='contacts'?'è¯çµ¡äºº':'å…¬å¸') + '</div><div class="empty-sub">è«‹å…ˆåœ¨ CRM ä¸­å¡«å…¥ Email æ¬„ä½</div></div>';
  } else {
    let rows = '';
    for (const item of items) {
      const checked = meSelected.has(item.email) ? 'checked' : '';
      const emailEsc = escHtml(item.email);
      rows += '<div class="recipient-row">' +
        '<input type="checkbox" ' + checked + ' onchange="meToggle(\'' + emailEsc + '\',this.checked)" style="width:16px;height:16px;cursor:pointer">' +
        '<div style="flex:1">' +
        '<div style="font-size:13.5px;font-weight:600">' + escHtml(item.name) + (item.title ? ' <span style="font-size:12px;font-weight:400;color:var(--gray-500)">' + escHtml(item.title) + '</span>' : '') + '</div>' +
        '<div style="font-size:12px;color:var(--gray-500)">' + (item.company ? '<b>' + escHtml(item.company) + '</b> &middot; ' : '') + emailEsc + '</div>' +
        '</div></div>';
    }
    listHtml = '<div style="max-height:360px;overflow-y:auto;padding:0 20px">' + rows + '</div>';
  }

  const tabStyle = (mode) => 'padding:8px 18px;font-size:13.5px;font-weight:500;cursor:pointer;background:none;border:none;color:' +
    (meMode===mode ? 'var(--primary)' : 'var(--gray-500)') + ';border-bottom:2px solid ' +
    (meMode===mode ? 'var(--primary)' : 'transparent') + ';margin-bottom:-2px';

  return '<div class="card">' +
    '<div class="card-header"><span class="card-title">é¸æ“‡æ”¶ä»¶å°è±¡</span><span id="me-count-badge" style="font-size:13px;color:var(--primary);font-weight:600">å·²é¸ ' + meSelected.size + ' ä½æ”¶ä»¶äºº</span></div>' +
    '<div class="card-body" style="padding:16px 20px 8px">' +
    '<div style="display:flex;border-bottom:2px solid var(--gray-200);margin-bottom:14px">' +
    '<button style="' + tabStyle('contacts') + '" onclick="meMode=\'contacts\';meSearchTerm=\'\';renderMassEmail()">ğŸ‘¤ è¯çµ¡äºº</button>' +
    '<button style="' + tabStyle('companies') + '" onclick="meMode=\'companies\';meSearchTerm=\'\';renderMassEmail()">ğŸ¢ å…¬å¸</button>' +
    '</div>' +
    '<div class="toolbar">' +
    '<div class="search-box"><span class="search-icon">ğŸ”</span><input type="text" placeholder="æœå°‹å§“åã€å…¬å¸ã€Email..." value="' + escHtml(meSearchTerm) + '" oninput="meSearchTerm=this.value;renderMassEmail()"></div>' +
    '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;color:var(--gray-600)"><input type="checkbox" ' + (allChecked?'checked':'') + ' onchange="if(this.checked){' + emails + '.forEach(e=>meSelected.add(e))}else{' + emails + '.forEach(e=>meSelected.delete(e))};renderMassEmail()" style="width:16px;height:16px"> å…¨é¸</label>' +
    '<span style="color:var(--gray-400);font-size:12px">' + items.length + ' ç­†æœ‰ Email</span>' +
    '</div></div>' +
    listHtml +
    '<div style="padding:16px 20px;border-top:1px solid var(--gray-100);display:flex;justify-content:flex-end">' +
    '<button class="btn btn-primary" onclick="if(meSelected.size>0){meStep=2;renderMassEmail()}else{toast(\'è«‹è‡³å°‘é¸æ“‡ä¸€ä½æ”¶ä»¶äºº\',\'error\')}" ' + (meSelected.size===0?'style="opacity:.5"':'') + '>ä¸‹ä¸€æ­¥ï¼šç·¨å¯«éƒµä»¶ â†’</button>' +
    '</div></div>';
}

function renderMeStep2() {
  return '<div class="card">' +
    '<div class="card-header"><span class="card-title">ç·¨å¯«éƒµä»¶å…§å®¹</span><span class="badge badge-blue">' + meSelected.size + ' ä½æ”¶ä»¶äºº</span></div>' +
    '<div class="card-body"><div class="form-grid">' +
    '<div class="form-group form-full"><label class="form-label">å¯„ä»¶äººé¡¯ç¤ºåç¨±</label><input class="form-input" id="me-sender" placeholder="ä¾‹ï¼šæ˜“æ˜åœ‹éš› æ¥­å‹™éƒ¨"></div>' +
    '<div class="form-group form-full"><label class="form-label">éƒµä»¶ä¸»æ—¨</label><input class="form-input" id="me-subject" placeholder="ä¾‹ï¼šã€æ˜“æ˜ã€‘ç»ç’ƒéš”ç†±ç¯€èƒ½å¡—å±¤æ–¹æ¡ˆèªªæ˜"></div>' +
    '<div class="form-group form-full">' +
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">' +
    '<label class="form-label" style="margin-bottom:0">éƒµä»¶å…§æ–‡</label></div>' +
    '<div style="margin-bottom:8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center">' +
    '<span style="font-size:12px;color:var(--gray-500)">æ’å…¥å€‹äººåŒ–æ¬„ä½ï¼š</span>' +
    '<span class="merge-chip" onclick="meInsertField(\'me-body\',\'{{å§“å}}\')">{{å§“å}}</span>' +
    '<span class="merge-chip" onclick="meInsertField(\'me-body\',\'{{å…¬å¸}}\')">{{å…¬å¸}}</span>' +
    '<span class="merge-chip" onclick="meInsertField(\'me-body\',\'{{è·ç¨±}}\')">{{è·ç¨±}}</span>' +
    '<span class="merge-chip" onclick="meInsertField(\'me-body\',\'{{æ¥­å‹™å“¡}}\')">{{æ¥­å‹™å“¡}}</span>' +
    '</div>' +
    '<textarea class="form-textarea" id="me-body" style="min-height:220px;font-family:inherit;line-height:1.7" placeholder="è¦ªæ„›çš„ {{å§“å}} æ‚¨å¥½ï¼Œ&#10;&#10;æ„Ÿè¬ {{å…¬å¸}} é•·æœŸä»¥ä¾†å°æ˜“æ˜åœ‹éš›çš„æ”¯æŒã€‚..."></textarea>' +
    '<div class="form-hint">ç³»çµ±æœƒè‡ªå‹•æŠŠ {{...}} æ›¿æ›æˆæ¯ä½æ”¶ä»¶äººçš„å¯¦éš›è³‡æ–™ï¼Œå¯¦ç¾å€‹äººåŒ–ç™¼é€ã€‚</div>' +
    '</div></div></div>' +
    '<div style="padding:16px 20px;border-top:1px solid var(--gray-100);display:flex;justify-content:space-between">' +
    '<button class="btn btn-secondary" onclick="meSaveCompose();meStep=1;renderMassEmail()">â† è¿”å›</button>' +
    '<button class="btn btn-primary" onclick="meSaveCompose();if(!meSubject.trim()){toast(\'è«‹å¡«å¯«éƒµä»¶ä¸»æ—¨\',\'error\');return}if(!meBody.trim()){toast(\'è«‹å¡«å¯«éƒµä»¶å…§æ–‡\',\'error\');return}meStep=3;renderMassEmail()">ä¸‹ä¸€æ­¥ï¼šé è¦½ç¢ºèª â†’</button>' +
    '</div></div>';
}

function renderMeStep3() {
  const allItems = getAllMeItems();
  const recipients = allItems.filter(i => meSelected.has(i.email));
  mePendingRecipients = recipients; // å­˜å…¨åŸŸï¼Œä¾› doSendEmails() ä½¿ç”¨
  const preview = recipients.slice(0, 3);

  let previewHtml = '';
  for (const r of preview) {
    const subj = escHtml(mergeFields(meSubject, r));
    const body = escHtml(mergeFields(meBody, r));
    previewHtml += '<div class="preview-email">' +
      '<div class="preview-email-header"><div style="display:flex;gap:16px;flex-wrap:wrap">' +
      '<div><div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;margin-bottom:2px">æ”¶ä»¶äºº</div><div style="font-size:13.5px;font-weight:600">' + escHtml(r.name) + ' &lt;' + escHtml(r.email) + '&gt;</div></div>' +
      '<div><div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;margin-bottom:2px">ä¸»æ—¨</div><div style="font-size:13.5px;font-weight:600">' + subj + '</div></div>' +
      '</div></div>' +
      '<div style="font-size:13px;color:var(--gray-700);white-space:pre-wrap;line-height:1.7;margin-top:10px">' + body + '</div></div>';
  }
  if (recipients.length > 3) {
    previewHtml += '<div style="text-align:center;color:var(--gray-400);font-size:13px;padding:8px">â€¦ ä»¥åŠå…¶ä»– ' + (recipients.length-3) + ' å°</div>';
  }

  const scriptSnippet = `    if (d.action === 'sendEmails') {
      const results = [];
      for (const item of d.emails) {
        try {
          GmailApp.sendEmail(item.to, item.subject, item.body, { name: d.senderName || 'æ˜“æ˜åœ‹éš›' });
          results.push({ to: item.to, success: true });
          Utilities.sleep(300);
        } catch(e) {
          results.push({ to: item.to, success: false, error: e.toString() });
        }
      }
      return out({ success: true, results });
    }`;

  return '<div class="card">' +
    '<div class="card-header"><span class="card-title">é è¦½èˆ‡ç¢ºèª</span><span class="badge badge-blue">å…± ' + recipients.length + ' å°</span></div>' +
    '<div class="card-body">' +
    (recipients.length > 500 ? '<div class="alert-warning" style="margin-bottom:14px">âš ï¸ Gmail ä¸€èˆ¬å¸³æˆ¶æ¯æ—¥ä¸Šé™ 500 å°ï¼Œä¼æ¥­ç‰ˆ 2000 å°ã€‚</div>' : '') +
    '<div style="background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:16px;margin-bottom:16px">' +
    '<div style="font-size:14px;font-weight:700;color:#15803d;margin-bottom:8px">ğŸ“§ æœ¬æ©Ÿå¿«é€Ÿç™¼é€ï¼ˆä¸éœ€é›²ç«¯è¨­å®šï¼‰</div>' +
    '<p style="font-size:13px;color:var(--gray-600);margin-bottom:12px">è¤‡è£½ä¸‹æ–¹ Email æ¸…å–®ï¼Œè²¼å…¥ Gmailã€Œå¯†ä»¶å‰¯æœ¬ï¼ˆBCCï¼‰ã€æ¬„ä½ï¼›å†è¤‡è£½ä¸»æ—¨èˆ‡å…§æ–‡å³å¯æ‰‹å‹•ç™¼é€ã€‚</p>' +
    '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">' +
    '<button class="btn btn-secondary btn-sm" onclick="copyEmailList()">ğŸ“‹ è¤‡è£½å…¨éƒ¨ Email</button>' +
    '<button class="btn btn-secondary btn-sm" onclick="copyMeSubject()">è¤‡è£½ä¸»æ—¨</button>' +
    '<button class="btn btn-secondary btn-sm" onclick="copyMeBody()">è¤‡è£½å…§æ–‡ï¼ˆé¦–ä½ç¯„æœ¬ï¼‰</button>' +
    '<a class="btn btn-secondary btn-sm" href="https://mail.google.com/mail/u/0/#compose" target="_blank">âœ‰ï¸ é–‹å•Ÿ Gmail</a>' +
    '</div>' +
    '<div style="background:#dcfce7;border-radius:6px;padding:8px 12px;font-family:monospace;font-size:12px;word-break:break-all;max-height:80px;overflow-y:auto">' + recipients.map(r=>r.email).filter(Boolean).join(', ') + '</div>' +
    '</div>' +
    '<div class="alert-info" style="margin-bottom:16px">ğŸ“‹ ä»¥ä¸‹ç‚ºå‰ ' + Math.min(3,preview.length) + ' å°éƒµä»¶é è¦½ï¼Œè«‹ç¢ºèªå€‹äººåŒ–æ¬„ä½é¡¯ç¤ºæ­£ç¢ºã€‚</div>' +
    previewHtml +
    (!config.scriptUrl ? '<div class="alert-warning" style="margin-top:16px">âš ï¸ è«‹å…ˆåœ¨ã€Œâš™ï¸ é›²ç«¯è¨­å®šã€ä¸­å®Œæˆ Apps Script è¨­å®šã€‚</div>' : '') +
    '<div class="setup-step" style="margin-top:16px">' +
    '<div class="setup-step-title"><span class="setup-step-num" style="background:var(--warning)">!</span>éœ€æ›´æ–° Apps Script æ‰èƒ½ç™¼é€éƒµä»¶</div>' +
    '<div class="setup-step-body"><p style="font-size:13px;color:var(--gray-600);margin-bottom:8px">åœ¨ Apps Script çš„ doPost å‡½æ•¸ä¸­ï¼Œæ–¼ <code style="background:var(--gray-100);padding:1px 5px">try {</code> æœ€é–‹é ­åŠ å…¥ä»¥ä¸‹ä»£ç¢¼ï¼Œå†é‡æ–°éƒ¨ç½²ï¼š</p>' +
    '<div style="position:relative"><div class="code-block" id="me-script-snippet">' + escHtml(scriptSnippet) + '</div>' +
    '<button class="copy-btn" onclick="navigator.clipboard.writeText(`' + scriptSnippet.replace(/`/g,'\\`') + '`).then(()=>toast(\'å·²è¤‡è£½ Apps Script ä»£ç¢¼\'))">ğŸ“‹ è¤‡è£½</button></div>' +
    '<p style="font-size:12px;color:var(--gray-500);margin-top:8px">åŠ å…¥ä»£ç¢¼å¾Œéœ€é‡æ–°ã€Œéƒ¨ç½²ã€ï¼ˆå»ºç«‹æ–°ç‰ˆæœ¬ï¼‰ï¼Œæ‰æœƒç”Ÿæ•ˆã€‚</p>' +
    '</div></div></div>' +
    '<div style="padding:16px 20px;border-top:1px solid var(--gray-100);display:flex;justify-content:space-between;align-items:center">' +
    '<button class="btn btn-secondary" onclick="meStep=2;renderMassEmail()">â† è¿”å›</button>' +
    '<button class="btn btn-primary" style="background:var(--success);border-color:var(--success)" onclick="doSendEmails()" ' + (!config.scriptUrl?'disabled style=\\"opacity:.5\\"':'') + '>ğŸ“§ ç¢ºèªç™¼é€ ' + recipients.length + ' å°éƒµä»¶</button>' +
    '</div></div>';
}

function copyEmailList() {
  const emails = (mePendingRecipients||[]).map(r=>r.email).filter(Boolean).join(', ');
  if (!emails) { toast('æ‰¾ä¸åˆ° Email æ¸…å–®','error'); return; }
  navigator.clipboard.writeText(emails).then(()=>toast('å·²è¤‡è£½ ' + (mePendingRecipients||[]).length + ' å€‹ Email åœ°å€'));
}
function copyMeSubject() {
  if (!meSubject) { toast('è«‹å…ˆå¡«å¯«ä¸»æ—¨','error'); return; }
  navigator.clipboard.writeText(meSubject).then(()=>toast('å·²è¤‡è£½ä¸»æ—¨'));
}
function copyMeBody() {
  if (!meBody) { toast('è«‹å…ˆå¡«å¯«å…§æ–‡','error'); return; }
  const first = (mePendingRecipients||[])[0];
  const text = first ? mergeFields(meBody, first) : meBody;
  navigator.clipboard.writeText(text).then(()=>toast('å·²è¤‡è£½å…§æ–‡ï¼ˆå·²å¥—ç”¨ç¬¬ä¸€ä½æ”¶ä»¶äººè³‡æ–™ï¼‰'));
}

async function doSendEmails() {
  const recipients = mePendingRecipients;
  if (!recipients || recipients.length === 0) { toast('æ‰¾ä¸åˆ°æ”¶ä»¶äººè³‡æ–™ï¼Œè«‹è¿”å›é‡æ–°é¸æ“‡','error'); return; }
  if (!config.scriptUrl) { toast('è«‹å…ˆåœ¨ã€Œâš™ï¸ é›²ç«¯è¨­å®šã€å¡«å…¥ Apps Script ç¶²å€','error'); openModal('settingsModal'); return; }

  document.getElementById('content').innerHTML =
    '<div class="card"><div class="card-header"><span class="card-title">ğŸ“§ ç™¼é€ä¸­...</span></div>' +
    '<div class="card-body" style="text-align:center;padding:48px">' +
    '<div style="font-size:56px;margin-bottom:16px">ğŸ“¨</div>' +
    '<div style="font-size:16px;font-weight:600;margin-bottom:8px">æ­£åœ¨é€é Gmail ç™¼é€...</div>' +
    '<div style="font-size:13px;color:var(--gray-500)">å…± ' + recipients.length + ' å°ï¼Œè«‹ç¨å€™ï¼ˆå‹¿é—œé–‰è¦–çª—ï¼‰</div>' +
    '<div style="background:var(--gray-100);border-radius:8px;overflow:hidden;margin:20px auto;max-width:300px"><div id="me-prog" style="height:8px;background:var(--primary);border-radius:8px;width:5%;transition:width .4s;animation:pulse 1s infinite alternate"></div></div>' +
    '</div></div>';

  let prog = 5;
  const timer = setInterval(() => { prog = Math.min(prog+3,88); const b=document.getElementById('me-prog'); if(b) b.style.width=prog+'%'; }, 600);

  try {
    const payload = {
      action: 'sendEmails',
      senderName: meSenderName || config.userName || 'æ˜“æ˜åœ‹éš›',
      emails: recipients.map(r => ({ to: r.email, subject: mergeFields(meSubject, r), body: mergeFields(meBody, r) }))
    };
    const res = await fetch(config.scriptUrl, { method:'POST', body:JSON.stringify(payload), redirect:'follow', headers:{'Content-Type':'text/plain;charset=utf-8'} });
    const json = await res.json();
    clearInterval(timer);

    if (json.success) {
      // è‹¥ Apps Script æ²’æœ‰ sendEmails handlerï¼Œjson.results æœƒæ˜¯ undefined
      if (!json.results) {
        clearInterval(timer);
        document.getElementById('content').innerHTML =
          '<div class="card"><div class="card-header"><span class="card-title">âš ï¸ éœ€è¦æ›´æ–° Apps Script</span></div>' +
          '<div class="card-body" style="text-align:center;padding:48px">' +
          '<div style="font-size:56px;margin-bottom:16px">ğŸ”§</div>' +
          '<div style="font-size:17px;font-weight:700;color:var(--warning);margin-bottom:12px">Apps Script å°šæœªåŠ å…¥éƒµä»¶ç™¼é€åŠŸèƒ½</div>' +
          '<div style="font-size:13.5px;color:var(--gray-600);line-height:1.8;margin-bottom:20px">è«‹å›åˆ°ã€Œç¬¬ä¸‰æ­¥ é è¦½ç™¼é€ã€é é¢ï¼Œè¤‡è£½ Apps Script ä»£ç¢¼ï¼Œ<br>è²¼å…¥æ‚¨çš„ Apps Script ä¸¦é‡æ–°éƒ¨ç½²å¾Œå†è©¦ä¸€æ¬¡ã€‚</div>' +
          '<button class="btn btn-primary" onclick="meStep=3;renderMassEmail()">â† è¿”å›æŸ¥çœ‹ä»£ç¢¼</button>' +
          '</div></div>';
        return;
      }
      const results = json.results;
      const ok = results.filter(r=>r.success).length;
      const fail = results.filter(r=>!r.success).length;
      recipients.forEach(r => {
        db.interactions.push({ id:genId('interactions'), companyId:'', contactId:'', type:'email', date:today(),
          subject:'[ç¾¤ç™¼] ' + mergeFields(meSubject,r), notes:'ç¾¤ç™¼éƒµä»¶ | æ”¶ä»¶ï¼š'+r.email, createdBy:currentUser(), createdAt:today() });
      });
      saveDB();
      document.getElementById('content').innerHTML =
        '<div class="card"><div class="card-header"><span class="card-title">âœ… ç™¼é€å®Œæˆ</span></div>' +
        '<div class="card-body" style="text-align:center;padding:48px">' +
        '<div style="font-size:64px;margin-bottom:16px">' + (fail===0?'ğŸ‰':'âš ï¸') + '</div>' +
        '<div style="font-size:22px;font-weight:700;color:' + (fail===0?'var(--success)':'var(--warning)') + ';margin-bottom:10px">' + (fail===0 ? 'æˆåŠŸç™¼é€ '+ok+' å°ï¼' : ok+' å°æˆåŠŸï¼Œ'+fail+' å°å¤±æ•—') + '</div>' +
        (fail>0 ? '<div style="font-size:13px;color:var(--danger);margin-bottom:10px">å¤±æ•—ï¼š' + results.filter(r=>!r.success).map(r=>r.to).join('ã€') + '</div>' : '') +
        '<div style="font-size:13px;color:var(--gray-500);margin-bottom:24px">ç™¼é€è¨˜éŒ„å·²è‡ªå‹•å¯«å…¥äº’å‹•è¨˜éŒ„</div>' +
        '<div style="display:flex;gap:10px;justify-content:center">' +
        '<button class="btn btn-secondary" onclick="navigate(\'interactions\')">æŸ¥çœ‹äº’å‹•è¨˜éŒ„</button>' +
        '<button class="btn btn-primary" onclick="meStep=1;meSelected=new Set();meSubject=\'\';meBody=\'\';renderMassEmail()">å†æ¬¡ç™¼é€</button>' +
        '</div></div></div>';
    } else { throw new Error(json.error || 'ç™¼é€å¤±æ•—'); }
  } catch(e) {
    clearInterval(timer);
    toast('ç™¼é€å¤±æ•—ï¼š' + e.message, 'error');
    meStep = 3; renderMassEmail();
  }
}


// ==================== DRAG & DROP ====================
window._isDragging = false;
let _dragDealId = null;

function handleDragStart(event, dealId) {
  window._isDragging = true;
  _dragDealId = dealId;
  event.dataTransfer.setData('text/plain', dealId);
  event.dataTransfer.effectAllowed = 'move';
  const card = event.currentTarget;
  setTimeout(() => card.classList.add('dragging'), 0);
}

function handleDragEnd(event) {
  event.currentTarget.classList.remove('dragging');
  document.querySelectorAll('.pipeline-col-body').forEach(col => {
    col.classList.remove('drag-over');
    col.classList.remove('drag-over-invalid');
  });
  setTimeout(() => { window._isDragging = false; }, 100);
}

function handleDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  document.querySelectorAll('.pipeline-col-body').forEach(col => col.classList.remove('drag-over'));
  event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
  if (!event.currentTarget.contains(event.relatedTarget)) {
    event.currentTarget.classList.remove('drag-over');
  }
}

function handleDrop(event, newStage) {
  event.preventDefault();
  const dealId = event.dataTransfer.getData('text/plain') || _dragDealId;
  event.currentTarget.classList.remove('drag-over');
  if (!dealId) return;
  const deal = db.deals.find(d => d.id === dealId);
  if (!deal) return;
  const oldStage = deal.stage;
  if (oldStage === newStage) return;
  deal.stage = parseInt(newStage);
  saveDB();
  renderPipeline();
  toast('âœ… å•†æ©Ÿå·²ç§»è‡³ã€Œ' + STAGES[parseInt(newStage)] + 'ã€');
}

// ==================== GLOBAL SEARCH ====================
function closeSearchResults() {
  document.getElementById('search-results').classList.remove('open');
}

function doGlobalSearch(q) {
  var el = document.getElementById('search-results');
  q = q.trim();
  if (!q) { el.classList.remove('open'); return; }
  var kw = q.toLowerCase();
  var html = '';

  // Companies
  var cos = db.companies.filter(function(c){
    return (c.name||'').toLowerCase().indexOf(kw)>=0 || (c.owner||'').toLowerCase().indexOf(kw)>=0 || (c.industry||'').toLowerCase().indexOf(kw)>=0;
  }).slice(0,4);
  if (cos.length) {
    html += '<div class="sr-section">ğŸ¢ å…¬å¸å®¢æˆ¶</div>';
    cos.forEach(function(c){
      html += '<div class="sr-item" onclick="navigate(\'companies\');closeSearchResults();document.getElementById(\'global-search-input\').value=\'\'">'
        + '<span class="sr-icon">ğŸ¢</span><div><div class="sr-main">'+escHtml(c.name)+'</div><div class="sr-sub">'+(c.industry||'')+(c.owner?' Â· '+c.owner:'')+'</div></div></div>';
    });
  }

  // Contacts
  var cts = db.contacts.filter(function(x){
    return (x.name||'').toLowerCase().indexOf(kw)>=0 || (x.title||'').toLowerCase().indexOf(kw)>=0 || (x.email||'').toLowerCase().indexOf(kw)>=0;
  }).slice(0,4);
  if (cts.length) {
    html += '<div class="sr-section">ğŸ‘¤ è¯çµ¡äºº</div>';
    cts.forEach(function(x){
      var co = db.companies.find(function(c){ return c.id===x.companyId; });
      html += '<div class="sr-item" onclick="navigate(\'contacts\');closeSearchResults();document.getElementById(\'global-search-input\').value=\'\'">'
        + '<span class="sr-icon">ğŸ‘¤</span><div><div class="sr-main">'+escHtml(x.name)+'</div><div class="sr-sub">'+(x.title||'')+(co?' Â· '+escHtml(co.name):'')+'</div></div></div>';
    });
  }

  // Deals
  var deals = db.deals.filter(function(d){
    return (d.title||'').toLowerCase().indexOf(kw)>=0;
  }).slice(0,4);
  if (deals.length) {
    html += '<div class="sr-section">ğŸ“ˆ å•†æ©Ÿ</div>';
    deals.forEach(function(d){
      var co = db.companies.find(function(c){ return c.id===d.companyId; });
      var stage = STAGES[stageIdx(d.stage)] || '';
      html += '<div class="sr-item" onclick="navigate(\'pipeline\');closeSearchResults();document.getElementById(\'global-search-input\').value=\'\'">'
        + '<span class="sr-icon">ğŸ“ˆ</span><div><div class="sr-main">'+escHtml(d.title)+'</div><div class="sr-sub">'+(co?escHtml(co.name)+' Â· ':'')+stage+(d.value?' Â· '+fmtMoney(d.value):'')+'</div></div></div>';
    });
  }

  // Interactions
  var ints = db.interactions.filter(function(i){
    return (i.subject||'').toLowerCase().indexOf(kw)>=0 || (i.notes||'').toLowerCase().indexOf(kw)>=0;
  }).slice(0,3);
  if (ints.length) {
    html += '<div class="sr-section">ğŸ’¬ äº’å‹•è¨˜éŒ„</div>';
    ints.forEach(function(i){
      var co = db.companies.find(function(c){ return c.id===i.companyId; });
      html += '<div class="sr-item" onclick="navigate(\'interactions\');closeSearchResults();document.getElementById(\'global-search-input\').value=\'\'">'
        + '<span class="sr-icon">ğŸ’¬</span><div><div class="sr-main">'+escHtml(i.subject)+'</div><div class="sr-sub">'+(co?escHtml(co.name)+' Â· ':'')+fmt(i.date)+'</div></div></div>';
    });
  }

  if (!html) html = '<div class="sr-empty">æ‰¾ä¸åˆ°ã€Œ' + escHtml(q) + 'ã€ç›¸é—œè³‡æ–™</div>';
  el.innerHTML = html;
  el.classList.add('open');
}

// ==================== PROJECTS ====================
let currentProjectId = null;

function resetProjectModal() {
  document.getElementById('projectModalTitle').textContent = editingId ? 'ç·¨è¼¯å°ˆæ¡ˆ' : 'æ–°å¢å°ˆæ¡ˆ';
  populateCompanySelect('prj-company', false);
  // populate won deals
  var dealSel = document.getElementById('prj-deal');
  dealSel.innerHTML = '<option value="">â€” ç„¡ â€”</option>';
  db.deals.filter(function(d){ return stageIdx(d.stage)===4; }).forEach(function(d){
    var co = db.companies.find(function(c){ return c.id===d.companyId; });
    var opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = d.title + (co ? ' (' + co.name + ')' : '');
    dealSel.appendChild(opt);
  });
  ['title','notes'].forEach(function(k){ var el=document.getElementById('prj-'+k); if(el) el.value=''; });
  ['start','end'].forEach(function(k){ var el=document.getElementById('prj-'+k); if(el) el.value=''; });
  document.getElementById('prj-status').value = 'active';
  document.getElementById('prj-progress').value = '';
  document.getElementById('prj-budget').value = '';
  document.getElementById('prj-cost').value = '';
  document.getElementById('prj-deal').value = '';
  if (editingId) {
    var p = db.projects.find(function(x){ return x.id===editingId; });
    if (p) {
      document.getElementById('prj-title').value = p.title||'';
      document.getElementById('prj-company').value = p.companyId||'';
      document.getElementById('prj-deal').value = p.dealId||'';
      document.getElementById('prj-start').value = p.startDate||'';
      document.getElementById('prj-end').value = p.endDate||'';
      document.getElementById('prj-status').value = p.status||'active';
      document.getElementById('prj-progress').value = p.progress||0;
      document.getElementById('prj-budget').value = p.budget||'';
      document.getElementById('prj-cost').value = p.actualCost||'';
      document.getElementById('prj-notes').value = p.notes||'';
    }
  }
}

function saveProject() {
  var title = document.getElementById('prj-title').value.trim();
  var companyId = document.getElementById('prj-company').value;
  if (!title) { toast('è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±', 'error'); return; }
  if (!companyId) { toast('è«‹é¸æ“‡å®¢æˆ¶å…¬å¸', 'error'); return; }
  var existing = editingId ? db.projects.find(function(x){ return x.id===editingId; }) : null;
  var obj = {
    id: editingId || genId('projects'),
    dealId: document.getElementById('prj-deal').value,
    companyId: companyId,
    title: title,
    startDate: document.getElementById('prj-start').value,
    endDate: document.getElementById('prj-end').value,
    status: document.getElementById('prj-status').value,
    progress: document.getElementById('prj-progress').value||'0',
    budget: document.getElementById('prj-budget').value,
    actualCost: document.getElementById('prj-cost').value,
    milestones: existing ? (existing.milestones||'[]') : '[]',
    notes: document.getElementById('prj-notes').value,
    createdAt: existing ? (existing.createdAt||today()) : today()
  };
  if (editingId) db.projects = db.projects.map(function(x){ return x.id===editingId?obj:x; });
  else db.projects.push(obj);
  saveDB(); closeModal('projectModal'); render(); toast(editingId?'å·²æ›´æ–°å°ˆæ¡ˆ':'å·²æ–°å¢å°ˆæ¡ˆ');
}

function deleteProject(id) {
  confirmDelete('ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿ', function(){
    db.projects = db.projects.filter(function(x){ return x.id!==id; });
    saveDB(); render(); toast('å·²åˆªé™¤å°ˆæ¡ˆ');
  });
}

function convertDealToProject(dealId) {
  var deal = db.deals.find(function(d){ return d.id===dealId; });
  if (!deal) return;
  // check if project already exists for this deal
  var existing = db.projects.find(function(p){ return p.dealId===dealId; });
  if (existing) { toast('æ­¤å•†æ©Ÿå·²æœ‰é€£çµå°ˆæ¡ˆ', 'error'); return; }
  editingId = null;
  openModal('projectModal');
  setTimeout(function(){
    document.getElementById('prj-title').value = deal.title;
    document.getElementById('prj-company').value = deal.companyId;
    document.getElementById('prj-deal').value = dealId;
    if (deal.actualCloseDate) document.getElementById('prj-start').value = deal.actualCloseDate;
    if (deal.budget) document.getElementById('prj-budget').value = deal.value||'';
    document.getElementById('prj-budget').value = deal.value||'';
  }, 50);
}

// â”€â”€ Milestone helpers â”€â”€
var _editMilestoneProjectId = null;

function openMilestoneModal(projectId) {
  _editMilestoneProjectId = projectId;
  document.getElementById('ms-title').value = '';
  document.getElementById('ms-due').value = '';
  openModal('milestoneModal');
}

function saveMilestone() {
  var title = document.getElementById('ms-title').value.trim();
  if (!title) { toast('è«‹è¼¸å…¥é‡Œç¨‹ç¢‘åç¨±', 'error'); return; }
  var p = db.projects.find(function(x){ return x.id===_editMilestoneProjectId; });
  if (!p) return;
  var ms = [];
  try { ms = JSON.parse(p.milestones||'[]'); } catch(e){}
  ms.push({ id: 'ms_'+Date.now(), title: title, dueDate: document.getElementById('ms-due').value, done: 'false' });
  p.milestones = JSON.stringify(ms);
  saveDB(); closeModal('milestoneModal'); renderProjectDetail(_editMilestoneProjectId); toast('é‡Œç¨‹ç¢‘å·²æ–°å¢');
}

function toggleMilestone(projectId, msId) {
  var p = db.projects.find(function(x){ return x.id===projectId; });
  if (!p) return;
  var ms = [];
  try { ms = JSON.parse(p.milestones||'[]'); } catch(e){}
  var m = ms.find(function(x){ return x.id===msId; });
  if (m) m.done = m.done==='true' ? 'false' : 'true';
  p.milestones = JSON.stringify(ms);
  saveDB(); renderProjectDetail(projectId);
}

function deleteMilestone(projectId, msId) {
  var p = db.projects.find(function(x){ return x.id===projectId; });
  if (!p) return;
  var ms = [];
  try { ms = JSON.parse(p.milestones||'[]'); } catch(e){}
  p.milestones = JSON.stringify(ms.filter(function(x){ return x.id!==msId; }));
  saveDB(); renderProjectDetail(projectId);
}

// â”€â”€ Render functions â”€â”€
function getStatusLabel(status) {
  return status==='completed' ? 'âœ… å·²å®Œå·¥' : status==='paused' ? 'â¸ æš«åœ' : 'ğŸ”¨ é€²è¡Œä¸­';
}
function getStatusColor(status) {
  return status==='completed' ? 'var(--success)' : status==='paused' ? 'var(--warning)' : 'var(--primary)';
}
function getProgressColor(pct) {
  return pct>=100 ? 'var(--success)' : pct>=60 ? 'var(--primary)' : pct>=30 ? 'var(--warning)' : 'var(--danger)';
}

function renderProjects() {
  if (!db.projects) db.projects = [];
  var el = document.getElementById('content');

  if (currentProjectId) {
    renderProjectDetail(currentProjectId);
    return;
  }

  if (db.projects.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸš§</div><div class="empty-title">å°šç„¡å°ˆæ¡ˆ</div><p style="font-size:13px;color:var(--gray-400)">é»æ“Šå³ä¸Šè§’ã€Œï¼‹ æ–°å¢ã€å»ºç«‹ç¬¬ä¸€å€‹å°ˆæ¡ˆï¼Œæˆ–å¾æˆäº¤å•†æ©Ÿç›´æ¥è½‰æ›</p></div>';
    return;
  }

  // summary stats
  var active = db.projects.filter(function(p){ return p.status==='active'; }).length;
  var completed = db.projects.filter(function(p){ return p.status==='completed'; }).length;
  var totalBudget = db.projects.reduce(function(a,p){ return a+(+p.budget||0); }, 0);
  var totalCost = db.projects.reduce(function(a,p){ return a+(+p.actualCost||0); }, 0);

  var statsHtml = '<div class="stats-grid" style="margin-bottom:20px">'
    + '<div class="stat-card"><div class="stat-icon" style="background:#eff6ff">ğŸš§</div><div class="stat-label">é€²è¡Œä¸­</div><div class="stat-value">'+active+'</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#f0fdf4">âœ…</div><div class="stat-label">å·²å®Œå·¥</div><div class="stat-value">'+completed+'</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#fefce8">ğŸ’°</div><div class="stat-label">åˆç´„ç¸½é¡</div><div class="stat-value" style="font-size:18px">'+(totalBudget>0?fmtMoney(totalBudget):'â€”')+'</div></div>'
    + '<div class="stat-card"><div class="stat-icon" style="background:#fef2f2">ğŸ“Š</div><div class="stat-label">å·²ç™¼ç”Ÿè²»ç”¨</div><div class="stat-value" style="font-size:18px">'+(totalCost>0?fmtMoney(totalCost):'â€”')+'</div></div>'
    + '</div>';

  var cards = '';
  db.projects.forEach(function(p) {
    var co = db.companies.find(function(c){ return c.id===p.companyId; });
    var pct = Math.min(+(p.progress)||0, 100);
    var ms = []; try { ms = JSON.parse(p.milestones||'[]'); } catch(e){}
    var msDone = ms.filter(function(m){ return m.done==='true'; }).length;
    var daysLeft = p.endDate ? daysDiff(p.endDate) : null;
    var overdue = daysLeft !== null && daysLeft < 0 && p.status !== 'completed';

    cards += '<div class="project-card" onclick="currentProjectId=\''+p.id+'\';renderProjects()">'
      + '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">'
      + '<div style="font-size:14px;font-weight:700;color:var(--gray-800);flex:1">'+escHtml(p.title)+'</div>'
      + '<span style="font-size:11px;font-weight:700;color:'+getStatusColor(p.status)+';white-space:nowrap;margin-left:8px">'+getStatusLabel(p.status)+'</span>'
      + '</div>'
      + '<div style="font-size:12px;color:var(--gray-500);margin-bottom:10px">ğŸ¢ '+(co?escHtml(co.name):'â€”')+'</div>'
      + '<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--gray-500);margin-bottom:6px">'
      + '<span>é€²åº¦ '+pct+'%</span>'
      + (ms.length>0?'<span>é‡Œç¨‹ç¢‘ '+msDone+'/'+ms.length+'</span>':'')
      + '</div>'
      + '<div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:'+pct+'%;background:'+getProgressColor(pct)+'"></div></div>'
      + '<div style="display:flex;justify-content:space-between;margin-top:10px;font-size:12px">'
      + '<span style="color:var(--gray-400)">'+(p.startDate?fmt(p.startDate)+' é–‹å§‹':'å°šæœªé–‹å·¥')+'</span>'
      + (p.endDate?'<span style="color:'+(overdue?'var(--danger)':'var(--gray-400)')+';font-weight:'+(overdue?'700':'400')+'">'+(overdue?'é€¾æœŸ':'é è¨ˆ')+'å®Œå·¥ '+fmt(p.endDate)+'</span>':'')
      + '</div>'
      + (p.budget?'<div style="margin-top:8px;font-size:12px;color:var(--gray-500)">åˆç´„ '+fmtMoney(+p.budget)+(p.actualCost?' / å·²ç™¼ç”Ÿ '+fmtMoney(+p.actualCost):'')+'</div>':'')
      + '</div>';
  });

  el.innerHTML = statsHtml + '<div class="project-grid">' + cards + '</div>';
}

function renderProjectDetail(projectId) {
  var p = db.projects.find(function(x){ return x.id===projectId; });
  if (!p) { currentProjectId=null; renderProjects(); return; }
  var el = document.getElementById('content');
  var co = db.companies.find(function(c){ return c.id===p.companyId; });
  var deal = p.dealId ? db.deals.find(function(d){ return d.id===p.dealId; }) : null;
  var pct = Math.min(+(p.progress)||0, 100);
  var ms = []; try { ms = JSON.parse(p.milestones||'[]'); } catch(e){}
  var msDone = ms.filter(function(m){ return m.done==='true'; }).length;
  var daysLeft = p.endDate ? daysDiff(p.endDate) : null;
  var overdue = daysLeft!==null && daysLeft<0 && p.status!=='completed';
  var budget = +p.budget||0;
  var cost = +p.actualCost||0;
  var profit = budget - cost;
  var margin = budget>0 ? Math.round(profit/budget*100) : null;

  // milestones HTML
  var msRows = '';
  if (ms.length===0) msRows = '<div style="text-align:center;padding:16px;color:var(--gray-400);font-size:13px">å°šæœªæ–°å¢é‡Œç¨‹ç¢‘</div>';
  else ms.forEach(function(m){
    var isDone = m.done==='true';
    msRows += '<div class="milestone-item">'
      + '<div class="ms-check '+(isDone?'done':'')+'" onclick="toggleMilestone(\''+p.id+'\',\''+m.id+'\')">'+(isDone?'âœ“':'')+'</div>'
      + '<div style="flex:1">'
      + '<div style="font-size:13px;font-weight:500;color:var(--gray-800);'+(isDone?'text-decoration:line-through;color:var(--gray-400)':'')+'">'+escHtml(m.title)+'</div>'
      + (m.dueDate?'<div style="font-size:12px;color:var(--gray-400)">ğŸ“… '+fmt(m.dueDate)+'</div>':'')
      + '</div>'
      + '<button class="btn btn-xs" style="color:var(--danger);border:1px solid var(--gray-200);background:#fff" onclick="deleteMilestone(\''+p.id+'\',\''+m.id+'\')">âœ•</button>'
      + '</div>';
  });

  el.innerHTML = ''
    // back button + header
    + '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">'
    + '<button class="btn btn-secondary btn-sm" onclick="currentProjectId=null;renderProjects()">â† è¿”å›</button>'
    + '<h2 style="font-size:17px;font-weight:700;flex:1">'+escHtml(p.title)+'</h2>'
    + '<span style="font-size:13px;font-weight:700;color:'+getStatusColor(p.status)+'">'+getStatusLabel(p.status)+'</span>'
    + '<button class="btn btn-secondary btn-sm" onclick="editingId=\''+p.id+'\';openModal(\'projectModal\')">âœï¸ ç·¨è¼¯</button>'
    + '<button class="btn btn-sm" style="color:var(--danger);border:1px solid var(--gray-200)" onclick="deleteProject(\''+p.id+'\')">ğŸ—‘ï¸</button>'
    + '</div>'
    // info row
    + '<div class="dash-grid" style="margin-bottom:16px">'
    // left col: progress + info
    + '<div style="display:flex;flex-direction:column;gap:16px">'
    + '<div class="card"><div class="card-header"><span class="card-title">ğŸ“Š å°ˆæ¡ˆé€²åº¦</span><span style="font-size:13px;font-weight:700;color:'+getProgressColor(pct)+'">'+pct+'%</span></div>'
    + '<div class="card-body">'
    + '<div class="progress-bar-wrap" style="height:12px;margin-bottom:12px"><div class="progress-bar-fill" style="height:12px;width:'+pct+'%;background:'+getProgressColor(pct)+'"></div></div>'
    + '<div style="display:flex;gap:24px;font-size:13px;flex-wrap:wrap">'
    + '<div><div style="color:var(--gray-500);font-size:11px">é–‹å·¥æ—¥æœŸ</div><div style="font-weight:600">'+(p.startDate?fmt(p.startDate):'æœªè¨­å®š')+'</div></div>'
    + '<div><div style="color:var(--gray-500);font-size:11px">é è¨ˆå®Œå·¥</div><div style="font-weight:600;color:'+(overdue?'var(--danger)':'inherit')+'">'+(p.endDate?fmt(p.endDate)+(overdue?' âš ï¸é€¾æœŸ'+Math.abs(daysLeft)+'å¤©':''):'æœªè¨­å®š')+'</div></div>'
    + (co?'<div><div style="color:var(--gray-500);font-size:11px">å®¢æˆ¶</div><div style="font-weight:600">'+escHtml(co.name)+'</div></div>':'')
    + (deal?'<div><div style="color:var(--gray-500);font-size:11px">é€£çµå•†æ©Ÿ</div><div style="font-weight:600">'+escHtml(deal.title)+'</div></div>':'')
    + '</div></div></div>'
    // budget card
    + '<div class="card"><div class="card-header"><span class="card-title">ğŸ’° è²»ç”¨æ¦‚æ³</span></div><div class="card-body">'
    + '<div class="budget-row"><span style="color:var(--gray-600)">åˆç´„é‡‘é¡</span><span style="font-weight:700">'+(budget>0?fmtMoney(budget):'â€”')+'</span></div>'
    + '<div class="budget-row"><span style="color:var(--gray-600)">å·²ç™¼ç”Ÿè²»ç”¨</span><span style="font-weight:700;color:var(--danger)">'+(cost>0?fmtMoney(cost):'â€”')+'</span></div>'
    + '<div class="budget-row"><span style="color:var(--gray-600)">é ä¼°æ¯›åˆ©</span><span style="font-weight:700;color:'+(profit>=0?'var(--success)':'var(--danger)')+'">'+(budget>0?fmtMoney(profit)+(margin!==null?' ('+margin+'%)':''):'â€”')+'</span></div>'
    + '</div></div>'
    + '</div>'
    // right col: milestones
    + '<div class="card"><div class="card-header"><span class="card-title">ğŸ é‡Œç¨‹ç¢‘</span>'
    + '<span style="font-size:12px;color:var(--gray-400)">'+msDone+'/'+ms.length+' å®Œæˆ</span>'
    + '<button class="btn btn-secondary btn-sm" onclick="openMilestoneModal(\''+p.id+'\')">ï¼‹ æ–°å¢</button>'
    + '</div><div class="card-body" style="padding:0 20px">'+msRows+'</div></div>'
    + '</div>'
    // notes
    + (p.notes?'<div class="card"><div class="card-header"><span class="card-title">ğŸ“ å‚™è¨»</span></div><div class="card-body"><p style="font-size:13px;color:var(--gray-600);line-height:1.7">'+escHtml(p.notes)+'</p></div></div>':'');
}

// ==================== INIT ====================
loadConfig();
loadLocalDB();
updateUserDisplay();
navigate('dashboard');
if (config.scriptUrl) {
  setSyncStatus('syncing');
  syncFromSheets();
} else {
  setSyncStatus('offline');
}
// Auto sync every 5 minutes
setInterval(()=>{ if(config.scriptUrl) syncFromSheets(); }, 5*60*1000);
</script>
</body>
</html>
